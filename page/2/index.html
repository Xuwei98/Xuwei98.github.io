<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="偽のブログ" type="application/atom+xml">






<meta name="description" content="圈地自萌,自娱自乐">
<meta property="og:type" content="website">
<meta property="og:title" content="偽のブログ">
<meta property="og:url" content="http://xwdidi.com/page/2/index.html">
<meta property="og:site_name" content="偽のブログ">
<meta property="og:description" content="圈地自萌,自娱自乐">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="偽のブログ">
<meta name="twitter:description" content="圈地自萌,自娱自乐">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Xuwei98'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://xwdidi.com/page/2/">





  <title>偽のブログ</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">偽のブログ</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xwdidi.com/2018/11/27/2018-11-27-L24内存换入-请求调页/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xuwei98">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="偽のブログ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/27/2018-11-27-L24内存换入-请求调页/" itemprop="url">内存管理    L24 内存换入-请求调页</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-27T00:00:00+08:00">
                2018-11-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/27/2018-11-27-L24内存换入-请求调页/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/27/2018-11-27-L24内存换入-请求调页/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  977
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  3
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="回顾与引导"><a href="#回顾与引导" class="headerlink" title="回顾与引导"></a>回顾与引导</h2><p>内存换出是从虚拟内存中引申出来的.</p>
<p>为什么需要虚拟内存呢,实现段页式,用虚拟内存进行分段,将虚拟内存分成一页一页的映射到物理内存中.</p>
<p>虚拟内存是连接分页分段的核心所在,分段分页管理内存的重要机制,换入换出是实现虚拟内存的关键.</p>
<p>分段,让用户使用.分页,提高内存效率.虚拟内存做中介.</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>基于虚拟内存的分段分页.换入换出机制实现虚拟内存. </p>
<p>段页同时存在时就拥有虚拟内存,用户程序只看到了0-4g的虚拟内存地址.割出内存存放,然后完成映射.</p>
<p>用户可以随意的使用这4个g的虚拟内存,就像拥有4g内存.用户程序是不知道如何映射的.</p>
<h4 id="用换入-换出实现”大内存”"><a href="#用换入-换出实现”大内存”" class="headerlink" title="用换入,换出实现”大内存”"></a>用换入,换出实现”大内存”</h4><p>4g虚拟内存是可能无法全部装入物理内存中的.</p>
<p>例:虚拟内存4g,物理内存1g.<br>换入换出,只有需要使用的内存地址,才进入物理内存中,其他数据暂时存储在物理磁盘上.等需要使用时再进行交换.</p>
<p>虚拟内存相当于仓库,物理内存相当于店面,从仓库拿出所需物品放到柜台上.(大概这个意思吧</p>
<p><strong>请求的时候才做映射</strong></p>
<h4 id="请求调页"><a href="#请求调页" class="headerlink" title="请求调页"></a>请求调页</h4><p>请求调入页面-&gt;建立映射.</p>
<ul>
<li>逻辑地址中的0-4g随意的虚拟地址,  然后访问段表得到虚拟内存地址.当虚拟地址真正的去映射的时候, 如果不存在映射的话(缺页),需要请求进行调页.</li>
</ul>
<p>执行地址,MMU发现<strong>缺页</strong>的时候,会发生中断.进行页错误处处理程序. 通过相关算法,找到磁盘中所需的页,并在空闲内存(<code>get_free_page()</code>)处进行映射. (换页)然后在执行中断前的指令.相当于对用户透明.</p>
<p>图一:<img src="https://i.loli.net/2018/11/28/5bfe8f718ebb8.jpg" alt></p>
<p>Q:采用请求调页不采用请求调段的原因是什么呢.</p>
<p>​    大概 (请求调页的粒度更细，更能提高内存效率)</p>
<p> 实现了虚拟内存的概念,</p>
<h3 id="实际的请求调页"><a href="#实际的请求调页" class="headerlink" title="实际的请求调页"></a>实际的请求调页</h3><ol>
<li><p>从哪里开始呢?</p>
<p>(1)是MMU硬件所做的,我们可以在缺页的中断开始.</p>
<p><img src="https://i.loli.net/2018/11/28/5bfe9181cf1b0.jpg" alt></p>
<p>设置好中断后怎么处理.</p>
<p>一下时处理程序的详细解析.</p>
<ol>
<li><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">trap_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;set_trap_gate(<span class="number">14</span>,spage_fault);&#125;<span class="comment">//设置14号中断</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> set_trap_gate(n,addr)\</span></span><br><span class="line">	_set_gate(&amp;idt[n],<span class="number">15</span>,<span class="number">0</span>,addr);</span><br></pre></td></tr></table></figure>
</li>
<li><p>处理中断page fault</p>
<p><img src="https://i.loli.net/2018/11/28/5bfe92454bd29.jpg" alt></p>
<p>上面是内核代码段,错误信息的线性地址(虚拟地址)在cr2中,并复制给edx.</p>
<p>并且压栈,调用相关处理函数. </p>
<p><img src="https://i.loli.net/2018/11/28/5bfe937cd0f69.jpg" alt></p>
</li>
<li><p>do_no_page(解析</p>
<p>调页具体操作.读磁盘,申请空闲内存,</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在1inux/mm/memory.c中</span></span><br><span class="line">void do_no_page()unsigned long error_code,unsigned long address)</span><br><span class="line">&#123;		</span><br><span class="line">	address&amp;=<span class="number">0xfffff000</span>;<span class="comment">//页面地址,得到偏移地址</span></span><br><span class="line">    </span><br><span class="line">	tmp=address-current-&gt;start code;<span class="comment">//页面对应的偏移</span></span><br><span class="line">	<span class="keyword">if</span>(!current-&gt;executablel||tmp&gt;=current-&gt;end_data)&#123;<span class="comment">//不是代码和数据</span></span><br><span class="line">        </span><br><span class="line">		get_empty_page()address);<span class="keyword">return</span>;&#125;</span><br><span class="line">page=get_free_page());<span class="comment">//获得空闲内存</span></span><br><span class="line">    </span><br><span class="line">bread_page(page,current-&gt;executable-&gt;i_dev,np);<span class="comment">// (blockread)磁盘读写,从这个设备中读写.</span></span><br><span class="line">    </span><br><span class="line">put_page(page,address);<span class="comment">//建立映射</span></span><br></pre></td></tr></table></figure>
<ul>
<li>中断</li>
<li>申请空闲页</li>
<li>读入需要页</li>
<li>建立映射</li>
<li>中断返回执行中断前的地址.</li>
</ul>
<p><img src="https://i.loli.net/2018/11/28/5bfe984d393c6.jpg" alt></p>
<ol start="4">
<li>put_page解析</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在1inux/mm/memory.c中</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="number">1</span><span class="function">ong put <span class="title">page</span><span class="params">(<span class="keyword">unsigned</span> <span class="number">1</span>ong page，<span class="comment">//物理地址</span></span></span></span><br><span class="line"><span class="function"><span class="params">                       </span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">unsigned</span> <span class="keyword">long</span> address)</span></span></span><br><span class="line"><span class="function">                       </span></span><br><span class="line"><span class="function"></span>&#123;<span class="keyword">unsigned</span> <span class="keyword">long</span> tmp，*page table;page_table=(<span class="keyword">unsigned</span> <span class="keyword">long</span>*)((address&gt;&gt;<span class="number">20</span>)&amp;ffc);<span class="comment">//页目录项</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(*page table)&amp;<span class="number">1</span>)</span><br><span class="line">	page_table=(<span class="keyword">unsigned</span> <span class="keyword">long</span>*)(Oxfffff000&amp;*page_table);</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">	tmp=get_free_page();</span><br><span class="line">	*page_table=tmpl7; page_table=(<span class="keyword">unsigned</span> <span class="number">1</span>ong*)tmp;&#125;</span><br><span class="line">	page_table[(address&gt;&gt;<span class="number">12</span>)&amp;<span class="number">0x3ff</span>]=pagel7; <span class="keyword">return</span> page;</span><br><span class="line">&#125;<span class="comment">//放入page_table上</span></span><br></pre></td></tr></table></figure>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>实现页面的换入,实现请求调页,无非就是中断处理(申请空闲也,读入需要页,建立映射),如果没有相关页,则进行中断处理.</p>
</li>
</ol>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xwdidi.com/2018/11/25/2018-11-25-日语第九课/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xuwei98">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="偽のブログ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/25/2018-11-25-日语第九课/" itemprop="url">アパート    第九课</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-25T00:00:00+08:00">
                2018-11-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/日语/" itemprop="url" rel="index">
                    <span itemprop="name">日语</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/25/2018-11-25-日语第九课/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/25/2018-11-25-日语第九课/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  285
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>イ类<br>安い　やすい</p>
<p>高い　たかい</p>
<p>低い　ひくい    </p>
<p>近い    　ちかい</p>
<p>遠い    　とおい    </p>
<p>新しい　あたたしい</p>
<p>古い　ふるい</p>
<p>大きい　おおきい</p>
<p>小さい　ちいさい</p>
<p>多い        おおい<br>少ない　すくない</p>
<p>難しい　むずかしい</p>
<p>易しい　やさしい</p>
<p>美味しい　おいしい</p>
<p>かわいい　可愛い</p>
<p>いい　よい</p>
<p>二类</p>
<p>しずか　静か</p>
<p>賑やか　にぎやか</p>
<p>便利　べんり</p>
<p>不便　ふべん</p>
<p>上手　じょうず</p>
<p>下手　へた</p>
<p>立派　りっぱ</p>
<p>複雑　ふくざつ</p>
<p>必要　ひつよう</p>
<p>ゆうめい　有名</p>
<p>綺麗　きれい</p>
<p>探します　さがします</p>
<p>選びます　えらびます</p>
<p>見ます　みます</p>
<p>きめます　決めます</p>
<p>払いまし　はらいます</p>
<p>家賃　やちん</p>
<p>ふどうさん　不動産</p>
<p>不動産会社</p>
<p>手続き　てつづき</p>
<p>保証人　ほしょにん</p>
<p>くるま　車</p>
<p>敷金　しききん</p>
<p>いい\よい</p>
<p>いい　よっくないです</p>
<p>いい　よくありません</p>
<p>I类否定:</p>
<p>く　＋　ありません</p>
<p>く　＋　ないです</p>
<p>II类否定:</p>
<p>は。。＋ではありません</p>
<p>ｘｘｘｘ　よりA／ANです</p>
<p>…(主语)は…よりA／ANです　より是前面的名词表示基准</p>
<p>..より…がA/ANです</p>
<p>Q：。。と・・と　どちらがA/ANですか　と表示并列</p>
<p>A:。。のほうがA/ANです　</p>
<p>…に近いです</p>
<p>。。。（起点）から遠いです</p>
<p>どぞう</p>
<p>日当たり　向阳处</p>
<p>昨日　きのう</p>
<p>きょう    　今日</p>
<p>最後　さいご</p>
<p>てつづき　手続き</p>
<p>保証人　ほしょうにん</p>
<p>素晴らしい　すばらしい</p>
<p>お住まい　おすまい</p>
<p>　飾り　かざり</p>
<p>上品　じょうひん</p>
<p>センス　</p>
<p>いいえ　とんでもありません</p>
<p>アパート　</p>
<p>和室　わしつ</p>
<p>襖　ふすま</p>
<p>押入　おしいれ</p>
<p>玄関　げんかん</p>
<p>洋室　ようしつ</p>
<p>マンション    n(数量)l(起居室)d(客厅)k(厨房)</p>
<p>アパート　一层或两层 木制</p>
<p>紹介　しょうかい</p>
<p>ふろ　</p>
<p>建物　たてもの</p>
<p>食堂　しょくどう</p>
<p>は　衬托主语</p>
<p>が　    谓语</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xwdidi.com/2018/11/24/2018-11-24-L23段页结合的实际内存管理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xuwei98">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="偽のブログ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/24/2018-11-24-L23段页结合的实际内存管理/" itemprop="url">内存管理      L23   段页结合的实际内存管理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-24T00:00:00+08:00">
                2018-11-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/24/2018-11-24-L23段页结合的实际内存管理/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/24/2018-11-24-L23段页结合的实际内存管理/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.3k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  5
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h2><p>操作系统分段分页管理内存.</p>
<p>用户程序分段管理.</p>
<p>物理内存采用分页机制有效利用内存.</p>
<h2 id="课程总结"><a href="#课程总结" class="headerlink" title="课程总结"></a>课程总结</h2><h3 id="如何结合在一起"><a href="#如何结合在一起" class="headerlink" title="如何结合在一起"></a>如何结合在一起</h3><h4 id="分段"><a href="#分段" class="headerlink" title="分段:"></a>分段:</h4><p>在虚拟内存中分区,割出区域;用户程序分段,然后建立映射关系.</p>
<h4 id="分页"><a href="#分页" class="headerlink" title="分页:"></a>分页:</h4><p>物理内存打散成固定大小的页,用户程序打散成页,映射到各个页上面.</p>
<h4 id="想法"><a href="#想法" class="headerlink" title="想法:"></a>想法:</h4><p>将分段后的内存分布与被打散成页的用户程序进行关联.</p>
<p>如何将二者进行等价呢.?</p>
<p>将虚拟内存中分好段的程序映射给分好页的物理内存上,应该可行.</p>
<p>内存即地址空间.割出一段地址,给用户程序中的段,再从虚拟(内存)地址空间上映射给物理内存页上.</p>
<p>虚拟内存是不能真正使用的.</p>
<h3 id="段、页同时存在：段面向用户-页面向硬件"><a href="#段、页同时存在：段面向用户-页面向硬件" class="headerlink" title="段、页同时存在：段面向用户/页面向硬件"></a>段、页同时存在：段面向用户/页面向硬件</h3><ol>
<li><p>虚拟内存上割出一个段存放应用程序(被隔离).然后操作系统将地址映射到物理内存上.</p>
<p><img src="https://i.loli.net/2018/11/23/5bf80f1a1829e.jpg" alt></p>
</li>
<li><p>隔离内存是为了让用户<strong>使用内存</strong>.</p>
<p>段页同时存在时的<strong>重定位</strong>(地址翻译).</p>
<ul>
<li><p>根据段表寻找基址,得到虚拟地址</p>
</li>
<li><p>操作系统根据页表得到页号和偏移地址形成物理地址.</p>
<p><img src="https://i.loli.net/2018/11/23/5bf8121d8754e.jpg" alt></p>
<p>例:<code>jmp 40</code></p>
<p>通过两层地址翻译到达物理地址. </p>
</li>
</ul>
<p>既支持了段,又支持了页.</p>
<p>做好实验6,实际的段页内存管理.</p>
<p>核心在于:逻辑地址-&gt;虚拟地址-&gt;物理地址.(两层映射).</p>
</li>
</ol>
<h3 id="一个实际的段、页式内存管理"><a href="#一个实际的段、页式内存管理" class="headerlink" title="一个实际的段、页式内存管理"></a>一个实际的段、页式内存管理</h3><p>内存管理核心就是内存分配，所以从程序放入内存、使用内存开始..</p>
<p>要给进程分配内存,</p>
<ul>
<li><p>分配段,建段表;分配页,建页表</p>
</li>
<li><p>进程带动内存使用的图谱</p>
</li>
<li><p>从进程<strong>fork</strong>中的内存分配开始,从到能使用内存结束</p>
<ul>
<li><p>如何载入内存呢?</p>
<p>将用户段和虚拟内存割出的区域进行关联,建立映射(段表). 分区适配算法.</p>
<p>再将这段区域割成小块,每块和物理页的页框关联在一起.</p>
<p>最终表现为数据的物理内存存放.</p>
</li>
<li><p>具体点:使用段表记录虚拟内存区域的记录,页表记录虚拟内存区域如何放到物理内存上.</p>
<p><img src="https://i.loli.net/2018/11/24/5bf911d550baa.jpg" alt></p>
</li>
</ul>
<p>例:<code>[300]</code>如何寻址呢.</p>
<p>查询段表得到<code>ds:300</code>,然后<code>0x000453000</code>查表得到页表和页框号,最后得到了<code>0x7300</code>. </p>
<ol>
<li>割一段区域</li>
<li>程序到虚拟内存中</li>
<li>物理内存寻找空闲页</li>
<li>建立页表,错判载入</li>
<li>能使用300地址</li>
</ol>
</li>
</ul>
<h4 id="1-从fork开始-分配虚存-建段表"><a href="#1-从fork开始-分配虚存-建段表" class="headerlink" title="1. 从fork开始 分配虚存,建段表"></a>1. 从fork开始 <strong>分配虚存,建段表</strong></h4><p>fork()-&gt;sys_fork-&gt;copy_process</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">copy_process</span><span class="params">(<span class="keyword">int</span> nr, <span class="keyword">long</span> ebp,..)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    copy_mem(nr,p);...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>copy_mem</code>解析</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">copy_mem</span><span class="params">(<span class="keyword">int</span> nr,task_struct *p)</span></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> new_data_base; </span><br><span class="line">	new_data_base=nr*<span class="number">0x4000000</span>;<span class="comment">//64M*nr (nr是代表第几个进程) 对虚拟内存的分割,割了64m,放入代码段数据段. ①</span></span><br><span class="line">    </span><br><span class="line">	set_base(p-&gt;<span class="number">1</span>dt[<span class="number">1</span>],<span class="keyword">new</span> data base);<span class="comment">//设置基址,填写段表 ②</span></span><br><span class="line">    </span><br><span class="line">	set_base(p-&gt;<span class="number">1</span>dt[<span class="number">2</span>],<span class="keyword">new</span> data base);<span class="comment">//进程切换 pcb指向的段表会跟着切换</span></span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2018/11/24/5bf91ebfc60d3.jpg" alt></p>
<ul>
<li><p>代码段,数据段都是一个段.</p>
</li>
<li><p>每个进程占64M虚拟地址空间，<strong>互不重叠</strong></p>
</li>
</ul>
<h4 id="虚拟地址与物理内存进行映射"><a href="#虚拟地址与物理内存进行映射" class="headerlink" title="虚拟地址与物理内存进行映射."></a>虚拟地址与物理内存进行映射.</h4><p>虚拟地址不重叠,所以分成的页也不会重叠.所以能共用一套页表.(简化的方法)</p>
<h4 id="2-接下来做什么呢-分配内存-建段表"><a href="#2-接下来做什么呢-分配内存-建段表" class="headerlink" title="2. 接下来做什么呢 ,分配内存,建段表"></a>2. 接下来做什么呢 ,分配内存,建段表</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">copy_mem</span><span class="params">(<span class="keyword">int</span> nr,task struct *p)</span></span></span><br><span class="line"><span class="function"></span>&#123; 	<span class="keyword">unsigned</span> <span class="keyword">long</span> old_data_base; </span><br><span class="line">	old_data_base=get_base(current-&gt;<span class="number">1</span>dt[<span class="number">2</span>]); </span><br><span class="line">    <span class="function">copy page <span class="title">tables</span><span class="params">(old_data_base,new_data_base,data_limit)</span></span>;<span class="comment">//赋值页表, 共用一套页表,根据虚拟地址进行页表的拷贝</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">copy_page_tables</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> from,<span class="keyword">unsigned</span> <span class="keyword">long</span> to,<span class="keyword">long</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	from_dir =(<span class="keyword">unsigned</span> <span class="keyword">long</span>*)(from&gt;&gt;<span class="number">20</span>)&amp;<span class="number">0xffc</span>);	<span class="comment">//右移20位,父进程的虚拟地址,原因看图</span></span><br><span class="line">    </span><br><span class="line">	to_dir=(<span class="keyword">unsigned</span> <span class="number">1</span>ong*)(to&gt;&gt;<span class="number">20</span>)&amp;<span class="number">0xffc</span>);</span><br><span class="line">	size=(<span class="keyword">unsigned</span> <span class="keyword">long</span>)(size+Ox3fffff)&gt;&gt;<span class="number">22</span>;</span><br><span class="line">	<span class="keyword">for</span>(;size--&gt;<span class="number">0</span>;from_dir++,to dir++)&#123;</span><br><span class="line">		from_page_table=(OXfffff000&amp;*from_dir);</span><br><span class="line">		to_page_table=get_free_page();</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2018/11/24/5bf924690ca5b.jpg" alt></p>
<p>为什么不右移22位呢,右移22位后乘以4,4是指针的大小.</p>
<h3 id="from-page-table-与to-page-table？"><a href="#from-page-table-与to-page-table？" class="headerlink" title="from_page_table 与to_page_table？"></a>from_page_table 与to_page_table？</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(;size--&gt;<span class="number">0</span>;from_dir++,to_dir++)&#123;</span><br><span class="line">	to_page_table=get_free)page();</span><br><span class="line">    *to_dir = ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)to_page_table) | <span class="number">7</span>;</span><br></pre></td></tr></table></figure>
<p>根据页框指针寻找真正的页框号.</p>
<p>to_dir是子进程的页目录.父进程的页目录已经指向分配好的内存.子进程要指向合适的内存页了,通过<code>get_free_page()</code>获得空闲内存页以便于分配.用的时候再建立映射,节约了内存空间.再将分配好的地址赋值给<code>to_dir</code>.</p>
<h5 id="get-free-page-解析"><a href="#get-free-page-解析" class="headerlink" title="get_free_page()解析"></a>get_free_page()解析<img src="https://i.loli.net/2018/11/24/5bf928141e063.jpg" alt></h5><h4 id="3-完成内存的拷贝"><a href="#3-完成内存的拷贝" class="headerlink" title="3. 完成内存的拷贝."></a>3. 完成内存的拷贝.</h4><p>父进程指向的地方,子进程也需要指向它.</p>
<p><img src="https://i.loli.net/2018/11/24/5bf929f90e7a0.jpg" alt></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>（；nr--&gt;<span class="number">0</span>；from_page_table++，to_page_table++）&#123;</span><br><span class="line">	this_page=*from_page_table;</span><br><span class="line">    this_page&amp;=~<span class="number">2</span>; <span class="comment">// 只读	写时复制</span></span><br><span class="line">    </span><br><span class="line">    *to_page_table = this_page;</span><br><span class="line">    *from_page_table=this_page;</span><br><span class="line">	this_page-=LOW_MEM; this_page &gt;&gt;=<span class="number">12</span>;</span><br><span class="line">	mem_map[this_page]++;<span class="comment">//作+1标记,多者共用内存空间,一个进程释放-1,直到0占用内存才被释放 &#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="4-程序-虚拟内-物理内存的模样"><a href="#4-程序-虚拟内-物理内存的模样" class="headerlink" title="4. 程序 虚拟内+物理内存的模样"></a>4. 程序 虚拟内+物理内存的模样</h3><p><img src="https://i.loli.net/2018/11/24/5bf92ca5ca970.jpg" alt></p>
<p>进程1<code>fork()</code>后形成进程2.</p>
<h3 id="5-放完后-如何使用呢"><a href="#5-放完后-如何使用呢" class="headerlink" title="5. 放完后,如何使用呢"></a>5. 放完后,如何使用呢</h3><p>段(LDT)表和页表建立好后,执行指令时MMU自动计算.</p>
<p>以下是大概流程.<code>*p = 7</code></p>
<p><img src="https://i.loli.net/2018/11/24/5bf92e9f0bf81.jpg" alt></p>
<p>fork后的进程二,因为原p的地址被设为只读了,为了避免其影响进程1,则会修改页表,再次申请一片新的内存,形成新的映射关系.</p>
<blockquote>
<p>进程拉动了内存</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xwdidi.com/2018/11/19/2018-11-19-L22多级页表与快表/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xuwei98">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="偽のブログ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/19/2018-11-19-L22多级页表与快表/" itemprop="url">内存管理   L22 多级页表与快表</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-19T00:00:00+08:00">
                2018-11-19
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/19/2018-11-19-L22多级页表与快表/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/19/2018-11-19-L22多级页表与快表/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  940
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  3
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h2><p>分页机制,物理系统变为一片一片固定大小的页,内存碎片少,空间利用率高.</p>
<p>单独分页机制的问题通过多级页表与快表解决.三个合在一起才能在基本的操作系统中运行.</p>
<h2 id="课程重点总结"><a href="#课程重点总结" class="headerlink" title="课程重点总结"></a>课程重点总结</h2><p>提高空间利用率,页小了,页表就大了.</p>
<p><img src="https://i.loli.net/2018/11/19/5bf2afea63309.jpg" alt></p>
<p>页表为什么会大呢,每页小了,页表项会增加.逻辑页号多了,(逻辑页号 = 地址(寻址范围0-4GB)/页大小).<code>jmp 40</code>40/100 = 0,第0页(逻辑页号),得到内存中的页框号(物理内存页).页表大了,浪费的多了,所以也应该小一点.太小了,也会导致页表项过大.</p>
<h4 id="页表会很大，页表放置就成了问题…"><a href="#页表会很大，页表放置就成了问题…" class="headerlink" title="页表会很大，页表放置就成了问题…"></a>页表会很大，页表放置就成了问题…</h4><ol>
<li><p>页面尺寸通常为4K，而地址是32位的，有2^20个页面,需要4m内存,系统中并发是个进程,就需要40M内存.对于内存消耗过大,过于浪费.32位最多调用4个G.</p>
<p>实际上大部分逻辑地址根本不会用到.</p>
</li>
<li><p>如何减少表的大小呢:</p>
<ol>
<li>只存放用到的页.</li>
</ol>
<ul>
<li><p>某一段地址没被使用,就从特表中删除.<b>用到的逻辑页才有页表项</b>.</p>
<p>不连续,需要遍历查找.时间复杂度太高.通过二分法查找有较大的速度提升,(通过总线访问内存,会降低CPU速率).会降低CPU速率不建议使用.</p>
</li>
<li><p>页号连续,只需要通过偏移地址就能快速定位.(32位地址空间+4K页面+页号必须连续&gt;220个页表项&gt;大页表占用内存，造成浪费.)</p>
</li>
<li><p>既要连续又要让页表占用内在少，如何做呢?参考书的章节目录和节目录来类比思考.</p>
</li>
</ul>
<ol start="2">
<li>多级页表.</li>
</ol>
<ul>
<li><p>分成不同”章节”,根据需要章节可以跳过不需要的章节.也就是不需要的东西不放到内存中.</p>
<p>多级页表，即页目录表 + 页表 <img src="https://i.loli.net/2018/11/19/5bf2c6f37b09c.jpg" alt></p>
<p>32位地址,一页4k.</p>
<p>页目录项中中间是空白的,仍占据位置以保持连续.2^10-&gt;2^10.每个页表项有2^10个,一页4kb,一个页目录项能指向了4M的空间.可以说这个程序(这个段)使用了12M的内存.在页目录项中,2^10个目录项x4字节地址 = 4k, 此时只占用4kx(3+1)= 16k的空间.(映射出的页表3x4k,自身页目录项4k).4k&lt;&lt;4m.</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p><strong>多级页表保证了变相连续性,查找速度快.又保证了内存占用小.</strong></p>
<p>每增加一级页表也增加了访问时间.用时间改变了占用大小.多级页表增加了访存的次数，尤其是64位系统.如何降低时间呢?</p>
<h3 id="快表"><a href="#快表" class="headerlink" title="快表"></a>快表</h3><p>TLB是一组相联快速存储器,是寄存器.(CPU中)</p>
<p><img src="https://i.loli.net/2018/11/19/5bf2ce38e59bc.jpg" alt></p>
<p>记住最近的页号比对,现在TLB中查询,没有再前往多级页表查询.</p>
<p>二者相结合,保证页表连续,查找迅速,减少了浪费.经常使用的放在快表中查询.</p>
<p>实现了空间与时间的优良性.</p>
<h3 id="TLB的得以发挥的原因"><a href="#TLB的得以发挥的原因" class="headerlink" title="TLB的得以发挥的原因"></a>TLB的得以发挥的原因</h3><p>TLB命中时效率会很高，未命中时效率降低</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"> </span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2018/11/19/5bf2cf20c3d72.jpg" alt></p>
<h4 id="如何提高TLB的命中率"><a href="#如何提高TLB的命中率" class="headerlink" title="如何提高TLB的命中率."></a>如何提高TLB的命中率.</h4><ol>
<li>越大越好,TLB很贵 通常大概有[64,1024].(折中)</li>
<li>合理的替换算法.</li>
</ol>
<h4 id="为什么在64-1024之间呢"><a href="#为什么在64-1024之间呢" class="headerlink" title="为什么在64-1024之间呢."></a>为什么在64-1024之间呢.</h4><ol>
<li><p>程序的地址访问存在局部性</p>
<p><img src="https://i.loli.net/2018/11/19/5bf2cfc136f21.jpg" alt></p>
<p>在某处会出现较多的访问. </p>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>TLB弥补多级页表访问太慢,</p>
<p>多级页表空间高效,访问较迅速</p>
<p>形成了在空间上高效,时间上快速的分页机制.</p>
</li>
</ol>
</li>
</ul>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xwdidi.com/2018/11/05/2018-11-05-DuiLib搭建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xuwei98">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="偽のブログ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/05/2018-11-05-DuiLib搭建/" itemprop="url">DuiLib环境搭建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-05T00:00:00+08:00">
                2018-11-05
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Duilib/" itemprop="url" rel="index">
                    <span itemprop="name">Duilib</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/05/2018-11-05-DuiLib搭建/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/05/2018-11-05-DuiLib搭建/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  163
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天弄了一天环境,终于编译成功了.如果这篇文章有幸被看到,希望能帮助你少走弯路.</p>
<ol>
<li>克隆DuiLib库<code>git clone https://github.com/duilib/duilib.git</code>,duilib中有个大写的DuiLib文件夹,这是我们需要编译的库.</li>
<li>在VS2015中,创建示例程序是从win32-&gt;win32项目创建的.</li>
<li>参考DuiLib的<a href="https://github.com/duilib/duilib/wiki/%E6%AD%A3%E7%A1%AE%E7%BC%96%E8%AF%91-Duilib-%E9%9D%99%E6%80%81%E5%BA%93%E7%9A%84%E6%96%B9%E6%B3%95" target="_blank" rel="noopener">wiki</a>,比较重要的是lib的引用:附加依赖项,附加包含目录,附加库目录.</li>
<li>如果采用的是文件的xml格式的话,一定要将xml与exe同一父目录下,不然会出现编译成功,却DuiLib加载资源失败的提示哦.</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xwdidi.com/2018/11/03/2018-11-03-(转载)UTF-8心得/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xuwei98">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="偽のブログ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/03/2018-11-03-(转载)UTF-8心得/" itemprop="url">(转载)为何建议使用UTF-8</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-03T00:00:00+08:00">
                2018-11-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/转载/" itemprop="url" rel="index">
                    <span itemprop="name">转载</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/03/2018-11-03-(转载)UTF-8心得/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/03/2018-11-03-(转载)UTF-8心得/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  8
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://utf8everywhere.org/zh-cn#myth.strlen.correctness" target="_blank" rel="noopener">http://utf8everywhere.org/zh-cn#myth.strlen.correctness</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xwdidi.com/2018/10/31/2018-10-31-孙鑫MFC第五节/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xuwei98">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="偽のブログ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/31/2018-10-31-孙鑫MFC第五节/" itemprop="url">孙鑫MFC第五节  文本编程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-31T00:00:00+08:00">
                2018-10-31
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MFC/" itemprop="url" rel="index">
                    <span itemprop="name">MFC</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/10/31/2018-10-31-孙鑫MFC第五节/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/10/31/2018-10-31-孙鑫MFC第五节/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.2k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  4
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="文本编程"><a href="#文本编程" class="headerlink" title="文本编程"></a>文本编程</h2><p>字处理程序,</p>
<p>记事本,notepad++ ,甚至是vc++都算是字处理程序.</p>
<p>都有光标,被叫做插入符.输入的文字信息,通过插入符添加.</p>
<h3 id="1-创建插入符"><a href="#1-创建插入符" class="headerlink" title="1. 创建插入符"></a>1. 创建插入符</h3><p>利用函数创建插入符,void CreateSolidCaret(int nWidth,int nHeight);插入符的宽度与高度.如果为0,被设置为系统定义的系统默认的窗口边界的宽度与高度.默认是隐藏的,需要调用<code>ShowCaret()</code>函数显示.</p>
<p>添加<code>WM_CREATE</code>消息处理,会自动增加OnCreate()函数(oncreate()不产生窗口，只是在窗口显示前设置窗口的属性如风格、位置等).而插入符大小应该根据字体改变.通过<code>GetTextMetrics()(HDC hdc,LPTEXTMETRIC,lptm);</code>获得字体信息, 将结构体的指针填入里面,获得信息.</p>
<h4 id="结构体解析"><a href="#结构体解析" class="headerlink" title="结构体解析"></a>结构体解析</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagTEXTMETRIC</span> &#123;</span></span><br><span class="line">  LONG tmHeight; 		<span class="comment">//高度,插入符与之相同</span></span><br><span class="line">    </span><br><span class="line">  LONG tmAscent; 		<span class="comment">//升序,图一</span></span><br><span class="line">    </span><br><span class="line">  LONG tmDescent; 		<span class="comment">//降序, </span></span><br><span class="line">    </span><br><span class="line">  LONG tmInternalLeading; </span><br><span class="line">  LONG tmExternalLeading; </span><br><span class="line">  LONG tmAveCharWidth; 	<span class="comment">//平均宽度值,</span></span><br><span class="line">    </span><br><span class="line">  LONG tmMaxCharWidth; <span class="comment">//最大字符宽度.</span></span><br><span class="line">    </span><br><span class="line">  LONG tmWeight;</span><br><span class="line">  LONG tmOverhang; </span><br><span class="line">  LONG tmDigitizedAspectX; </span><br><span class="line">  LONG tmDigitizedAspectY; </span><br><span class="line">  <span class="keyword">char</span> tmFirstChar; </span><br><span class="line">  <span class="keyword">char</span> tmLastChar; </span><br><span class="line">  <span class="keyword">char</span> tmDefaultChar; </span><br><span class="line">  <span class="keyword">char</span> tmBreakChar; </span><br><span class="line">  BYTE tmItalic; </span><br><span class="line">  BYTE tmUnderlined; </span><br><span class="line">  BYTE tmStruckOut; </span><br><span class="line">  BYTE tmPitchAndFamily; </span><br><span class="line">  BYTE tmCharSet; </span><br><span class="line">&#125; TEXTMETRIC;</span><br></pre></td></tr></table></figure>
<p>图一:<img src="https://i.loli.net/2018/11/03/5bddad46ec47a.jpg" alt></p>
<p> 获得信息,然后使用它,</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> CTextView::OnCreate(LPCREATESTRUCT lpCreateStruct)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (CView::OnCreate(lpCreateStruct) == <span class="number">-1</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span>  在此添加您专用的创建代码</span></span><br><span class="line">    </span><br><span class="line">	<span class="function">CClientDC <span class="title">dc</span><span class="params">(<span class="keyword">this</span>)</span></span>;	<span class="comment">//父类存在GetDC()函数,使用this调用.</span></span><br><span class="line">    </span><br><span class="line">	TEXTMETRIC tm;</span><br><span class="line">	dc.GetTextMetrics(&amp;tm);  <span class="comment">//已经获得</span></span><br><span class="line"></span><br><span class="line">	CreateSolidCaret(tm.tmAveCharWidth / <span class="number">8</span>, tm.tmHeight);		<span class="comment">//除以8,宽度较为合适</span></span><br><span class="line">    </span><br><span class="line">	ShowCaret();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-创建图形插入符"><a href="#2-创建图形插入符" class="headerlink" title="2. 创建图形插入符."></a>2. 创建图形插入符.</h4><p>创建前构造对象<code>CBitmap bitmap</code>,并使用<code>LoadBitmap</code>初始化,<code>CreateCaret(CBitmap * pBitmap)</code> 创建.不过bitma p应该为成员变量.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CTextView</span> :</span> <span class="keyword">public</span> CView</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">private</span>:</span><br><span class="line">		CBitmap bitmap;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> CTextView::OnCreate(LPCREATESTRUCT lpCreateStruct)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (CView::OnCreate(lpCreateStruct) == <span class="number">-1</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span>  在此添加您专用的创建代码</span></span><br><span class="line">    </span><br><span class="line">	<span class="function">CClientDC <span class="title">dc</span><span class="params">(<span class="keyword">this</span>)</span></span>;	<span class="comment">//父类存在GetDC()函数,使用this调用.</span></span><br><span class="line">    </span><br><span class="line">	TEXTMETRIC tm;</span><br><span class="line">	dc.GetTextMetrics(&amp;tm);  <span class="comment">//已经获得</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//CreateSolidCaret(tm.tmAveCharWidth / 8, tm.tmHeight);		//除以8,宽度较为合适</span></span><br><span class="line">    </span><br><span class="line">	<span class="comment">//CBitmap bitmap;	//局部对象,执行完OnCreate()会被析构.所以放到CTextView成员变量中.</span></span><br><span class="line">    </span><br><span class="line">	bitmap.LoadBitmapW(IDB_BITMAP3);</span><br><span class="line">	CreateCaret(&amp;bitmap);</span><br><span class="line">	ShowCaret();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-窗口输出文字"><a href="#3-窗口输出文字" class="headerlink" title="3. 窗口输出文字"></a>3. 窗口输出文字</h3><p>可以使用<code>TextOut()</code>显示文字,但是进行重绘的时候会被擦除掉,我们要保留文字的话,在重绘的时候要重新输出文字.发生重绘的时候会调用函数<code>OnDraw()</code>,该函数会传入<code>CDC</code>指针(CDC已经封装好较多的函数),直接去使用CDC的函数.</p>
<h4 id="CString类"><a href="#CString类" class="headerlink" title="CString类"></a>CString类</h4><p>字符的大小匹配分配内存都有本身封装好的完成.使用CString对象,字符,字符指针等构造CString.</p>
<p><code>LoadString()</code>装载ID标识的资源到现存的CString中.先通过资源视图<code>String Table</code>里创建新的字符号,然后加载.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> CTextView::OnDraw(CDC* pDC)	<span class="comment">//发生重绘的时候会调用该函数</span></span><br><span class="line">    </span><br><span class="line">&#123;</span><br><span class="line">	CTextDoc* pDoc = GetDocument();</span><br><span class="line">	ASSERT_VALID(pDoc);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!pDoc)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> 在此处为本机数据添加绘制代码</span></span><br><span class="line">	<span class="comment">//CString str("see me");</span></span><br><span class="line">    </span><br><span class="line">	CString str;</span><br><span class="line">	str = <span class="string">L"see me"</span>;</span><br><span class="line">	pDC-&gt;TextOutW(<span class="number">50</span>, <span class="number">50</span>, str);  </span><br><span class="line"></span><br><span class="line">	str.LoadStringW(<span class="number">61446</span>);		<span class="comment">//新建的ID号</span></span><br><span class="line">    </span><br><span class="line">	pDC-&gt;TextOutW(<span class="number">0</span>, <span class="number">200</span>, str);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-创建路进程"><a href="#4-创建路进程" class="headerlink" title="4. 创建路进程"></a>4. 创建路进程</h3><p><code>CDC::BeginPath()</code>在路径中打开以后，应用程序可以开始调用绘制功能的GDI定义该点集在路径。 应用程序可以通过调用 <code>EndPath</code>成员函数关闭一个打开的路径括号。 当应用程序调用 <code>BeginPath</code>时，将丢弃所有以前的路径。</p>
<p>文本显示宽度需要有各种条件得到,但可以通过<code>CDC::GetTextExtent</code>得到,返回<code>CSize</code>对象.CSize来自SIZE结构体.<code>Size</code>中有<code>cx  cy</code>表示高宽.也能通过字符串获取在屏幕中的高度与宽度.</p>
<p>当第21,23行被注释掉时,会出现默认填充的黑色矩形框.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">void</span> CTextView::OnDraw(CDC* pDC)	<span class="comment">//发生重绘的时候会调用该函数</span></span><br><span class="line">    </span><br><span class="line">&#123;</span><br><span class="line">	CTextDoc* pDoc = GetDocument();</span><br><span class="line">	ASSERT_VALID(pDoc);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!pDoc)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> 在此处为本机数据添加绘制代码</span></span><br><span class="line">	<span class="comment">//CString str("see me");</span></span><br><span class="line">    </span><br><span class="line">	CString str;</span><br><span class="line">	str = <span class="string">L"see me"</span>;</span><br><span class="line">	pDC-&gt;TextOutW(<span class="number">50</span>, <span class="number">50</span>, str);</span><br><span class="line"></span><br><span class="line">	CSize sz = pDC-&gt;GetTextExtent(str);	<span class="comment">//获得高宽.</span></span><br><span class="line"></span><br><span class="line">	str.LoadStringW(<span class="number">61446</span>);		<span class="comment">//新建的ID号</span></span><br><span class="line">    </span><br><span class="line">	pDC-&gt;TextOutW(<span class="number">0</span>, <span class="number">200</span>, str);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//pDC-&gt;BeginPath();		//确定文本显示大小.</span></span><br><span class="line">    </span><br><span class="line">	pDC-&gt;Rectangle(<span class="number">50</span>, <span class="number">50</span>, <span class="number">50</span> + sz.cx, <span class="number">50</span> + sz.cy);</span><br><span class="line">	<span class="comment">//pDC-&gt;EndPath();</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="探究路进程的作用"><a href="#探究路进程的作用" class="headerlink" title="探究路进程的作用."></a>探究路进程的作用.</h4><p>画黑色线条,</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">300</span>; i += <span class="number">10</span>)</span><br><span class="line">&#123;</span><br><span class="line">	pDC-&gt;MoveTo(<span class="number">0</span>, i);</span><br><span class="line">	pDC-&gt;LineTo(<span class="number">300</span>, i);</span><br><span class="line">	pDC-&gt;MoveTo(i, <span class="number">0</span>);</span><br><span class="line">	pDC-&gt;LineTo(i, <span class="number">300</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> <img src="https://i.loli.net/2018/11/04/5bdef90a07e16.jpg" alt></p>
<p>做互操作,使用<code>SelectClipPath</code>函数.选择当前路径作为一个剪辑区域(绘图区域)的设备上下文，了新的区域与任何现有的剪辑区域通过使用指定的模式。</p>
<p><img src="https://i.loli.net/2018/11/04/5bdefcaad44f9.jpg" alt>当前选择路径被排除(RGN_DIFF参数).而RGN_AND只在该区域有图.</p>
<p>不学了!!!垃圾MFC.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xwdidi.com/2018/10/25/2018-10-25-L21内存分区与分页/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xuwei98">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="偽のブログ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/25/2018-10-25-L21内存分区与分页/" itemprop="url">内存管理   L21 内存分区与分页</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-25T00:00:00+08:00">
                2018-10-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/10/25/2018-10-25-L21内存分区与分页/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/10/25/2018-10-25-L21内存分区与分页/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.7k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  6
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id><a href="#" class="headerlink" title="#"></a>#</h1><p>操作系统管理CPU,内存,管理磁盘(设备驱动,文件系统),差不多是比较完整的操作系统</p>
<p>分段和分页是真正形成了操作系统内存管理</p>
<ol>
<li>引出内存分区</li>
<li>讲解内存分区,引出分页</li>
<li><p>讲解分页</p>
<p>CPU的取指执行,就是使用的内存的过程,也就是程序跑起来的过程.</p>
</li>
</ol>
<p>程序是分段处理的,不同的段有不同的作用与特点,执行不同的功能.</p>
<p>如何使用内存呢,<br>​    将程序放入内存空闲处,若存在指令<code>jmp 40</code>,放入到内存3000处,就是内存被占用. 再将数据段的信息放入到内存中.通过取值执行,执行到<code>jmp 40</code>时,根据LDT表中记录的首地址进行地址翻译,(运行时的重定位);通过LDTR寄存器指向LDT表的起始地址,然后根据<code>jmp 40</code>中的段地址寄存器寻找到对应的LDT表,然后得到了物理地址.这已经开始执行程序了.</p>
<p>那么其他进程怎么执行,那就创建第二个进程相关的LDT表,LDT表示放到了进程的PCB中.根据LDT进行执行时的重定位.进行合适的跳转.切换PCB后,LDT也当然会切换.LDTR也会修改,指向另一个新表.<code>switch_to()</code>执行后的<code>jmp 40</code>也会发生改变.进程的切换,LDT也会切换,在很早之前所说的映射表其实就是LDT.</p>
<ol>
<li><p>程序分段(编译阶段)</p>
</li>
<li><p>内存中寻找空间分区</p>
<p> 几个算法+数据结构</p>
</li>
<li><p>读入程序(文件系统,磁盘管理)</p>
<p>设备驱动</p>
</li>
<li><p>初始化LDT表和PCB.</p>
<p>建立映射表,与PCB关联</p>
</li>
</ol>
<h2 id="课程总结"><a href="#课程总结" class="headerlink" title="课程总结"></a>课程总结</h2><ol>
<li>如何去寻找空闲的内存区域.</li>
</ol>
<p>​    这样就可以将程序的各个段载入到相应的内存分区中了.</p>
<ol start="2">
<li><p>如何分割内存呢</p>
<ul>
<li><p>固定分区</p>
<p>等分，操作系统初始化时将内存等分成k个分区</p>
<p>但孩子有大有小，段也有大有小，需求不一定</p>
</li>
<li><p>可变分区的管理.</p>
<p>需要多少,在空闲区域分配多少</p>
<p><img src="https://i.loli.net/2018/10/25/5bd1d40d4c3b7.jpg" alt></p>
<ol>
<li>空闲区域为250k-500k,有个请求为<code>reqSize = 100K</code>,通过数据结构记录内存区域划分, 空闲分区表起始地址改变为350k,长度为150k,已分配分区表增加一行相应的信息就可以了.但不一定只是使用,也会有释放.如段2不再需要,释放内存.在空闲分区表添加相应一行就行了.已分配分区表删除seg2.</li>
</ol>
<p><img src="https://i.loli.net/2018/10/25/5bd1d6f3dc272.jpg" alt></p>
<p>​    </p>
<ol start="2">
<li><p>再次申请</p>
<p>又一个段提出内存请求:<code>reqSize = 40k</code>这时候两个空闲区段,如何判断选哪一个更合适呢. </p>
</li>
</ol>
<p>操作系统一般会选择折中的算法,</p>
<p>首先适配:(350,150),查询速度快,在第一位,O(1)算法</p>
<p>最佳适配:(200,50),空闲区域越来越小,容易碎片化</p>
<p>最差适配:(350,150),可以得到比较均匀的内存分配区域,无法得到过大的内存区域,O(n)算法</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结,"></a>总结,</h4><p>操作系统为了将内存使用起来,将会分成多个段.程序放入到空闲区域.</p>
<ol>
<li>维护数据结构</li>
<li>选择合适的算法,加上合适的数据结构,段的结构,在PCB初始化代码添加,就能管理起内存,最小的操作系统就能建立起来.</li>
</ol>
</li>
</ul>
</li>
<li><p>现代操作系统也支持分页,为什么,如何去支持分页.</p>
<p>其实并不使用内存分区,为了让段放到内存中(段会采用虚拟内存进行率先处理),段物理内存实际采用了内存分页进行割断,</p>
<p>虚拟内存采用最佳适配分区分割,而物理内存采用分页分段的方法.</p>
</li>
</ol>
<h3 id="引入分页：解决内存分区导致的内存效率问题"><a href="#引入分页：解决内存分区导致的内存效率问题" class="headerlink" title="引入分页：解决内存分区导致的内存效率问题"></a>引入分页：解决内存分区导致的内存效率问题</h3><p>内存分区效率不高:分区完,无论使用任何方法总会产生内存碎片,然而采用分页就不会出现.(为什么呢)</p>
<p>例如:</p>
<p><code>reqSize = 160k</code>任何一个区域都放不进去,即使是有内存,也放不进去.</p>
<p><img src="https://i.loli.net/2018/10/27/5bd4314c1c07b.jpg" alt></p>
<p>如何不浪费这些内存呢.</p>
<ol>
<li><p>将空闲分区合并,需要移动1个段,<strong>内存紧缩</strong>:需要花大量时间,而且时间过长容易被识别为死机状态.</p>
</li>
<li><p>将请求打散,160k分为两个小段.</p>
<p>针对每个段内存请求，系统一页一页的分配给给这个段.(向上取整).好处在于对于使用不完的页,减少内存的浪费.最多浪费1页,并且不用内存紧缩.之前在<code>mem_init()</code>中,以每页4kb大小进行初始化.</p>
<p>用户希望分段,程序由段组成,物理内存分页,段页合在一起.建立基本的操作系统.</p>
<p>连续-&gt;离散.</p>
<p><code>jmp 40</code>如何跳转到相应的页数上,1页长度为100,40是第0页,所以会跳转到第五个页框<code>540</code>.</p>
<p><img src="https://i.loli.net/2018/10/27/5bd44527717fb.jpg" alt></p>
<p>页0放在页框5中，页0中的地址就需要重定位</p>
<p>那么如何计算,根据之前段的计算,我们将采用页表.</p>
<p><img src="https://i.loli.net/2018/10/27/5bd449feada4b.jpg" alt></p>
<p>段表的寄存器为LDTR,页表的寄存器为CR3.进程切换时,cr3也会跟着切换.</p>
<p>40/100余40,那么就是页0,便宜40.</p>
<p>4k = 2^12. 2240/4k.右移12位,右移3个数.只剩下2,所以得到<code>0x02|0x240</code>,(由内存管理单元MMU计算得到).</p>
<p>MMU如何运行的了,读取到指令后,将地址右移12位,根据页表指针(PCB中)在表中寻找.页号为2,页框好为3,然后的到物理地址0x3240.</p>
<p>内存的段是很多页组成的,页表指针也和PCB关联,执行这条指令需要去查询页表,进行重定位.</p>
<blockquote>
<p>在基本的分页概念中，我们把程序分成<strong>等长</strong>的小块。这些小块叫做“<strong>页（Page）</strong>”，同样内存也被我们分成了和页面同样大小的”<strong>页框（Frame）“，</strong>一个页可以装到一个页框里。在执行程序的时候我们根据一个页表去查找某个页面在内存的某个页框中，由此完成了逻辑到物理的映射。</p>
<p><a href="https://www.zhihu.com/question/50796850" target="_blank" rel="noopener">https://www.zhihu.com/question/50796850</a></p>
</blockquote>
</li>
</ol>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>   一个程序是由多个段组成,每一个段不是直接放在内存中,直接放到内存中的话容易引起内存的浪费,造成大量碎片.将段打散成多个页,每个段要放在页中.为了将来实现重定位,找到程序执行的地址,就要建立页表.</p>
<p>开启分页前,内核所有地址都变成了虚拟地址,所有的地址都要通过 MMU 映射到物理地址再访问内存</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xwdidi.com/2018/10/23/2018-10-23-L20内存使用与分段/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xuwei98">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="偽のブログ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/23/2018-10-23-L20内存使用与分段/" itemprop="url">内存管理     L20 内存使用与分段</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-23T00:00:00+08:00">
                2018-10-23
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/10/23/2018-10-23-L20内存使用与分段/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/10/23/2018-10-23-L20内存使用与分段/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.4k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  5
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="课程总结"><a href="#课程总结" class="headerlink" title="课程总结"></a>课程总结</h2><p>​    如何管理CPU,多进程图像切换or同步等,</p>
<p>操作系统如何管理内存?</p>
<h3 id="内存如何使用"><a href="#内存如何使用" class="headerlink" title="内存如何使用"></a>内存如何使用</h3><ol>
<li><p>计算机如何工作</p>
<p>取指-执行-取指-执行-…….</p>
<p>是从内存中取出,</p>
<p>因为使用了内存,才能取出.</p>
<p><strong>内存使用</strong>:将程序放到内存中,PC指向开始地址</p>
</li>
</ol>
<ol start="2">
<li><p>如何让程序加载到程序中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text</span><br><span class="line">_entry:			//入口地址</span><br><span class="line"></span><br><span class="line">	call _main</span><br><span class="line">	call _exit</span><br><span class="line">_main:</span><br><span class="line">	...</span><br><span class="line">	ret</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">_entry://入口地址</span><br><span class="line"></span><br><span class="line">	call 40</span><br><span class="line">	call xx</span><br><span class="line">main://偏移是40</span><br></pre></td></tr></table></figure>
<p>通过entry跳回到从开头偏移40的main函数,</p>
<hr>
<p>编译完放到磁盘中,通过读入磁盘放进内存中.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">内存地址		物理内存</span><br><span class="line">   			...</span><br><span class="line">40 			_main:mov [300],0</span><br><span class="line">			...</span><br><span class="line">   			call xx</span><br><span class="line"> 0 			call 40</span><br></pre></td></tr></table></figure>
<p>call 40,跳回到40执行通过地址总线发送40,物理地址40的位置就是main函数的第一条命令(也就是入口地址).</p>
<p>IP = 0,<code>call 40</code>就跳入到了main函数,</p>
<p>缺点在于,程序起始位置必须放到固定物理内存0地址处.PC指针等于0,才能正确执行.0地址处不一定存在空闲,而且这样的话也容易与新程序冲突.而且0地址开始处放入的是操作系统程序.</p>
<p><strong>所以</strong>应该把程序放到空闲内存处,如果程序其实地址为1000,那么<code>call 40</code>不应该跳入到40地址处.应该跳入到1040地址处.</p>
<p>这时候应该<strong>重定位</strong>(PE文件相关知识):修改程序中的地址(是相对地址)(逻辑地址).在程序放入到内存中,将40修改成1040.<code>300</code>必成1300.</p>
<ul>
<li><p>什么时候完成重定位?</p>
<p><u>编译时</u>,不现实,在PC中,需要知道执行时的内存空闲位置几乎不可能知道.然而在一些卫星,嵌入式中(静态系统中),可以实现.不够灵活.编译时重定位的程序只能放在内存固定位置,效率高.</p>
<p><u>载入时</u>,更容易实现,更灵活,只需要将所有地址都加上基地址的值就可以了.更加灵活.载入时重定位的程序一旦载入内存就不能动了,速度较慢.</p>
<ul>
<li><p>程序载入后还需要移动</p>
<p>交换(swap):内存资源紧张,磁盘较大,磁盘中的虚拟内存和内存进行数据交换</p>
<p><img src="https://i.loli.net/2018/10/23/5bcf2b03ee289.jpg" alt></p>
</li>
</ul>
<p>所以是<strong>执行每条指令时</strong>进行<strong>重定位</strong>,每执行一条指令都要地址翻译.基地址+偏移地址= 物理地址.(地址翻译)</p>
<ul>
<li><p>如何去存放基地址呢? 如何去更换基地址?</p>
<p>进程中发生的这些变化的依据<u>基地址</u>都放在进程的PCB中,基地址会随着加载内存地址的改变而改变.</p>
<p>执行指令时第一步先从PCB中取出这个基地址.</p>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>   编译好程序 </p>
<p>   在内存中寻找空闲内存,创建进程,PCB</p>
<p>   将空闲地址放入到PCB中,</p>
<p>   基地址放在基地址寄存器中.switch_to()时,也切换PCB.</p>
<pre><code>可执行程序找到空闲内存,拿出基地址放入PCB中,然后放入到这段空闲内存中,上下文切换时,PCB的基地址等于基地址寄存器的值,每次地址执行时,都要进行地址翻译,寻找到物理地址,执行.
</code></pre><ol>
<li>假设执行<code>mov ax,[100]</code></li>
</ol>
<ul>
<li>PCB中基地址赋值给寄存器,从寄存器取出地址后,要访问100这个地址,通过地址翻译(基地址+100),找到实际的地址.得到该处数据.</li>
</ul>
<ol start="2">
<li>执行switch</li>
</ol>
<ul>
<li><p>然后将进程2的PCB中的基地址写入到基地址寄存器中.2000变为1000.再执行<code>mov ax,[100]</code>,就去访问了1100.</p>
<p><img src="https://i.loli.net/2018/10/23/5bcf335525a5c.jpg" alt></p>
</li>
</ul>
<h3 id="引入分段"><a href="#引入分段" class="headerlink" title="引入分段"></a>引入分段</h3><p>是将整个程序载入到内存中吗?</p>
<p>程序是由若干段组成的,堆(.heap),栈(.heap),代码区,初始化数据段,未初始化数据段.</p>
<p>符合用户观点,独立考虑每个段的特点,用途(分治)可以通过&lt;段号.段内偏移&gt;访问.例如<code>mov [es:bx],ax</code>. 如果所有程序全放在一起,是无法分小段载入.</p>
<h4 id="不是将整个程序，是将各段分别放入内存"><a href="#不是将整个程序，是将各段分别放入内存" class="headerlink" title="不是将整个程序，是将各段分别放入内存"></a>不是将整个程序，是将各段分别放入内存</h4><p>​    如果不是分段存储,而是整段放入的话.栈是会持续增长的,如果存储空间不够,需要申请新的较大内存空间,然后再将原数据拷贝到那,此时会造成二者空间皆不可用造成内存的浪费.</p>
<p>​    如果分段放入,只需要移动单一的栈存储空间,提高了内存的使用率,也符合了人们的使用习惯</p>
<p>指令: <code>&lt;段号.段内偏移&gt;</code></p>
<p>当然这也会造成各段基地址不一样, 所以需要通过查询<strong>段表</strong>来记录每个段相应的基地 址. </p>
<p>比如之前<code>jmp 0, 8</code>通过0去查询gdt表获得基地址CS&lt;&lt;4+ip 采用保护模式寻址，cs=8用来查GDT表，表内偏移为0;然而GDT的表是处理操作系统的.每个进程有自己的段表<strong>LDT</strong>.</p>
<p>所以最后采用GDT+LDT的寻址方式,获得自己的基地址处.每次进行地址翻译时,根据LDT表中的段地址进行查询.</p>
<p><img src="https://i.loli.net/2018/10/24/5bd06a892dcdb.jpg" alt></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>一个程序多个段,然后每个段在内存中找到内存空闲处,将基地址放入到LDT表中,LDT查询表是由多个LDT表线性组成,</p>
<p>初始化LDT表后,</p>
<p>赋值给PCB,</p>
<p>设好初始地址,</p>
<p>PC指针取值执行,每次执行时,进行查表查找基地址,然后找到物理地址.</p>
<p>就能进行相关操作了.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xwdidi.com/2018/10/19/2018-10-19-实验-进程运行轨迹的跟踪与统计/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xuwei98">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="偽のブログ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/19/2018-10-19-实验-进程运行轨迹的跟踪与统计/" itemprop="url">进程运行轨迹的跟踪与统计</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-19T00:00:00+08:00">
                2018-10-19
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统实验/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统实验</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/10/19/2018-10-19-实验-进程运行轨迹的跟踪与统计/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/10/19/2018-10-19-实验-进程运行轨迹的跟踪与统计/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  449
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://www.shiyanlou.com/courses/115/labs/570/document" target="_blank" rel="noopener">实验指导</a></p>
<p><a href="http://www.oldlinux.org/download/clk011c-3.0.pdf" target="_blank" rel="noopener">linux内核完全注释</a></p>
<p>今天简单跟着实验楼的操作系统原理与实践,第四个进程轨迹的跟踪.</p>
<p>实际上难点的在于是如何去判断切换点的位置所在,然后进行输出就行醒了,这对于源码的理解变得更加深层,当然这可以通过读书去了解 读&lt;&lt;linux内核完全注释&gt;&gt;,经过代码注释能很好理解相关内核函数的运行.</p>
<p>这个实验自己做的话,bochs系统没有启动成功虚拟机里,实验楼环境里也是,</p>
<p>最后做出来了,原因是函数中加载文件描述符的一行没有写进去,.,</p>
<p>通过修改main.c 启动进程,修改文件加载符的位置,和打开文件流,进行输入输出. 通过阅读代码获知进程改变时的位置在那进行添加记录代码,</p>
<p>试一次较为比较有深度的试验探索了</p>
<blockquote>
<p>总的来说，Linux 0.11支持四种进程状态的转移：就绪到运行、运行到就绪、运行到睡眠和睡眠到就绪，此外还有新建和退出两种情况。其中就绪与运行间的状态转移是通过schedule()（它亦是调度算法所在）完成的；运行到睡眠依靠的是sleep_on()和interruptible_sleep_on()，还有进程主动睡觉的系统调用sys_pause()和sys_waitpid()；睡眠到就绪的转移依靠的是wake_up()。所以只要在这些函数的适当位置插入适当的处理语句就能完成进程运行轨迹的全面跟踪了。</p>
</blockquote>
<p>睡眠其实就是堵塞状态.</p>
<p>希望这个实验我能去更加好的理解源码.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Xuwei98">
            
              <p class="site-author-name" itemprop="name">Xuwei98</p>
              <p class="site-description motion-element" itemprop="description">圈地自萌,自娱自乐</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">51</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Xuwei98" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:z1002280879@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
<br>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=1350129459&auto=1&height=66"></iframe>

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xuwei98</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">47.7k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://xuwei98.disqus.com/count.js" async></script>
    

    

  




	





  














  





  

  

  

  
  

  

  

  

</body>
</html>
