<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="偽のブログ" type="application/atom+xml">






<meta name="description" content="圈地自萌,自娱自乐">
<meta property="og:type" content="website">
<meta property="og:title" content="偽のブログ">
<meta property="og:url" content="http://xwdidi.com/index.html">
<meta property="og:site_name" content="偽のブログ">
<meta property="og:description" content="圈地自萌,自娱自乐">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="偽のブログ">
<meta name="twitter:description" content="圈地自萌,自娱自乐">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Xuwei98'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://xwdidi.com/">





  <title>偽のブログ</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">偽のブログ</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xwdidi.com/2019/04/01/2019-4-1-VC线程注入失败/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xuwei98">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="偽のブログ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/01/2019-4-1-VC线程注入失败/" itemprop="url">VC：执行远程线程注入的代码段导致目标进程崩溃</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-01T00:00:00+08:00">
                2019-04-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/错误整理/" itemprop="url" rel="index">
                    <span itemprop="name">错误整理</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/04/01/2019-4-1-VC线程注入失败/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/04/01/2019-4-1-VC线程注入失败/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  615
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  2
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天使用植物大战僵尸练习线程注入调用call的时候,一直处于崩溃状态,,后来查阅了教程博客,下面有人指出了问题所在 在此引用下老哥的博客文章.</p>
<p><a href="https://blog.csdn.net/kk20078733/article/details/5530884" target="_blank" rel="noopener">原文地址</a></p>
<blockquote>
<p>以前也曾多次提到远程线程注入导致进程崩溃的现象。</p>
<p>此次崩溃不同于前几次。</p>
<p>之前，采用的是dll注入的方式，注入后，由于同一个dll文件在不同的进程中映射的基地址不同，导致远程线程函数的入口地址不同，以至崩溃，这种情况，多数是本进程采用静态链接加载待远程注入的dll文件，而其他进程则动态加载该dll文件，两次加载将在内存中产生两个dll实例。</p>
<p>此次，需要向远程进程注入代码段，远程线程函数入口地址正确。测试时，为了方便，特地增加了一个消息框MessageBox，远程线程函数仅仅调用这个弹出消息框的函数，然后退出。结果，消息框正常弹出，但是，当点击确定退出消息框后，目标进程立即崩溃。原因不明。</p>
<p>200807210756注：</p>
<p>实在不知道问题出哪儿了，于是就想看看注入的VC代码对应的反汇编代码，这时，忽然想到一点，即：我都是在Debug模式下执行的，这可能会有问题。</p>
<p>进一步思考。Debug版本和Release版本最大的不同在于，每次调用一个函数后，Debug版本会进行堆栈检测。而目标进程显然是处于release模式，此时，如果注入的是Debug版本的代码，那么，调用函数之后，会有一句检测堆栈的机器指令，这很可能就是进程崩溃的原因所在。</p>
<p>于是，改为release环境测试，一切正常！OK！</p>
<p>(我用控制台程序实现时没有问题，用MFC程序实现就有问题，因此发现以上内容，将Debug版改为Release版就没问题了)</p>
<p>另附上远程注入的主要代码段，供参考，有问题望指教！！！</p>
<p>作者：kk20078733<br>来源：CSDN<br>原文：<a href="https://blog.csdn.net/kk20078733/article/details/5530884" target="_blank" rel="noopener">https://blog.csdn.net/kk20078733/article/details/5530884</a> </p>
</blockquote>
<p>Debug版会使用一个检查堆栈平衡的函数_checkesp..</p>
<p>详细的在小黄书中有讲到.现在记得不是很清楚.</p>
<p>有机会的话会写上来.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xwdidi.com/2019/03/15/2019-3-13-语言要点复习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xuwei98">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="偽のブログ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/15/2019-3-13-语言要点复习/" itemprop="url">语言复习       查漏补缺 不定时更新</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-15T00:00:00+08:00">
                2019-03-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/15/2019-3-13-语言要点复习/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/03/15/2019-3-13-语言要点复习/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.3k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  4
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="语言要点复习"><a href="#语言要点复习" class="headerlink" title="语言要点复习"></a>语言要点复习</h1><h3 id="内存区域"><a href="#内存区域" class="headerlink" title="内存区域"></a>内存区域</h3><h4 id="bss段"><a href="#bss段" class="headerlink" title=".bss段"></a>.bss段</h4><p> (block started by symbol segmengt) 符号段块的起始位置</p>
<p>只存在于运行在内存中的可执行文件中.保存程序的起始地址和结束地址.不存在于硬盘的二进制文件中</p>
<p>因为一般用来存放未初始化的全局变量和静态变量,在程序之行开始时,这段区域的未初始化的都会被初始化为0,</p>
<p>以便内存区能在运行时分配并被有效地清零.不同架构可能有不同的方法.</p>
<p>.bss段从可执行文件中得到,链接器得到这个段大小的内存块,紧跟在数据段之后.</p>
<h4 id="data-段"><a href="#data-段" class="headerlink" title=".data 段"></a>.data 段</h4><p>data segment数据段,存放初始化好的全局变量,静态变量.</p>
<p>这个位置通常属于只读的.静态常量区.</p>
<p><code>char *a = &quot;Windows&quot;</code>,这个Windows字符串属于.data段,只读属性.如果运行<code>*a = &#39;a&#39;</code>会造成访问冲突.</p>
<p>大小在编译链接时自动分配.和全局变量,静态变量,常量有关</p>
<p>.bss+.data=静态存储区.存放静态变量 全局变量 常量(常变量,字符串常量)已经初始化,不可被修改</p>
<p>局部变量通过指针,引用访问和修改.</p>
<p>全局变量在静态存储区不可以被间接修改.</p>
<h4 id="text-段"><a href="#text-段" class="headerlink" title=".text 段"></a>.text 段</h4><p>程序代码段, 存放二进制代码,编译后是静态不可变的.</p>
<p>为什么要设置这个段呢.程序语言文本是只读的,数据不是.每次加载代码,会固定加载到内存中.减少内存的使用,增加的内存的复用.</p>
<h4 id="stack-栈"><a href="#stack-栈" class="headerlink" title="stack 栈"></a>stack 栈</h4><p>堆栈,存放局部变量的区域,使用<code>push</code>指令压栈.调用函数执行<code>call</code>前,参数压栈,函数返回结果也会压栈放回.</p>
<p>VS默认栈为1M,64bits的linux栈默认10mb.</p>
<h4 id="heap-堆"><a href="#heap-堆" class="headerlink" title="heap 堆"></a>heap 堆</h4><p>FIFO的数据结构.用来保障函数内存分布.</p>
<p>malloc new 申请</p>
<p>free delete 删除对重指定信息</p>
<p>malloc 放回void* ,new返回类型指针,并执行构造函数</p>
<h3 id="静态变量"><a href="#静态变量" class="headerlink" title="静态变量"></a>静态变量</h3><p>存储在静态存储区,在整个程序运行期间一直占据这些空间. 内存地址是不变的.不过不能在作用域外使用.</p>
<p>所有全局变量都是静态变量,而局部变量只有定义时加上static修饰符,才能成为局部静态变量.</p>
<p>不会随着函数的启动和结束而消失.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">strA</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> str[] = <span class="string">"hello"</span>;</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">strA</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> str* = <span class="string">"hello"</span>;<span class="comment">//字符串位于常量区,处于静态存储区.生命周期内恒定不变的.无法被改变</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="指针"><a href="#指针" class="headerlink" title="指针"></a>指针</h4><p><code>int c[2][3]</code> 表示数组c有两组3个数字的数组.</p>
<p><code>c</code>表示数组首地址 表示的是二维数组行指针</p>
<p><code>*c</code>第一行元素的首地址,是一维指针,是二维数组的列指针.</p>
<p><code>**c</code>取第一个元素的值.</p>
<p><code>char (*str)[20]</code>数组指针.执行数组元素的指针</p>
<p><code>char *str[20]</code>指针数组,数组成员为<code>char *</code>指针</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span>  <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> arr[] = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> *p=arr;<span class="comment">//首个元素的首地址</span></span><br><span class="line">    </span><br><span class="line">    *(p++)+=<span class="number">123</span>;<span class="comment">//计算完成后 指向第二个元素</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d,%d\n"</span>, *p,*(++p)); <span class="comment">//参数从左往右看,此时p指向第三个元素</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是没有返回值,没有参数的函数</p>
<p><code>void f(void)</code></p>
<p>这是一个指向函数的指针,该函数没有返回值和参数</p>
<p><code>void(*p)(void)</code></p>
<p>上述指针的类型</p>
<p><code>void (*)(void)</code></p>
<p>对该类型的强制转换</p>
<p><code>(void (*)(void))</code></p>
<p>对该类型的强制转换</p>
<p><code>(void (*)(void))0</code></p>
<h4 id="让程序跳转到绝对地址是0x100000去执行"><a href="#让程序跳转到绝对地址是0x100000去执行" class="headerlink" title="让程序跳转到绝对地址是0x100000去执行"></a>让程序跳转到绝对地址是0x100000去执行</h4><p><code>((void (*)())0x100000)()</code></p>
<h3 id="const-static"><a href="#const-static" class="headerlink" title="const static"></a>const static</h3><h4 id="先说const"><a href="#先说const" class="headerlink" title="先说const"></a>先说const</h4><p>const 是表示常量的标识符.</p>
<p>const char * A  A指针指向的变量是不可变的</p>
<p>char const *A    和上述一样</p>
<p>char *const A    指针本身是不可变的,所以必须被初始化.而变量可以改变</p>
<h4 id="static-标识符"><a href="#static-标识符" class="headerlink" title="static 标识符"></a>static 标识符</h4><ul>
<li><p>如果在全局变量加上static,被限定了作用域,只能在该源文件中使用.从而保证了在其他源文件中不被使用.只被初始化一次.</p>
<p>改变了作用域和使用范围</p>
</li>
<li><p>给局部变量加上的static的话,在局部函数结束后不会消失,且是最新的状态.</p>
<p>只被初始化一次</p>
<p>(编译器在该目标编译单元内只有该函数的入口地址,没有函数名,其他编译单元不能通过函数名调用该函数,)</p>
<p>随着程序结束而消失</p>
</li>
<li><p>static函数在内存中只存在一份,普通函数存在复数拷贝</p>
</li>
<li><p>类的成员函数中加上,该类的对象同时共用这一个成员函数,成员变量也是.</p>
</li>
</ul>
<h3 id="面向对象"><a href="#面向对象" class="headerlink" title="面向对象"></a>面向对象</h3><p>多态:<a href="https://zh.wikipedia.org/wiki/%E5%A4%9A%E5%9E%8B_(%E7%89%A9%E4%BB%B6%E5%B0%8E%E5%90%91%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88" target="_blank" rel="noopener">多态</a>)（Polymorphism）是指由继承而产生的相关的不同的类，其对象对同一消息会做出不同的响应<a href="https://zh.wikipedia.org/wiki/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1#cite_note-8" target="_blank" rel="noopener">[8]</a></p>
<p><a href="https://zh.wikipedia.org/wiki/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1</a></p>
<p>很有意思的讲解</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xwdidi.com/2019/03/04/2019-03-04-L30-文件使用磁盘的实现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xuwei98">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="偽のブログ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/04/2019-03-04-L30-文件使用磁盘的实现/" itemprop="url">设备驱动与文件系统   L30 文件使用的磁盘的实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-04T00:00:00+08:00">
                2019-03-04
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/04/2019-03-04-L30-文件使用磁盘的实现/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/03/04/2019-03-04-L30-文件使用磁盘的实现/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  502
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="上文总结"><a href="#上文总结" class="headerlink" title="上文总结"></a>上文总结</h2><p>从字符流算出盘块号</p>
<p>使用映射表算出.</p>
<h2 id="重点总结"><a href="#重点总结" class="headerlink" title="重点总结"></a>重点总结</h2><p><code>fs/read_write.c</code></p>
<p><img src="https://i.loli.net/2019/03/04/5c7d2647b2806.jpg" alt></p>
<p>参数分别是文件描述符,缓冲区,读写字符的个数.处理字符流的一段</p>
<p>获得inode(FCB),根据字符流的位置算出盘块号,读就完事了.</p>
<p>给出inode,file,缓冲区,长度, 运行file_write,取出对应盘块号的信息放入队列中,进行修改,再存入.</p>
<p>,</p>
<p>,</p>
<h3 id="file-write的工作流程"><a href="#file-write的工作流程" class="headerlink" title="file_write的工作流程"></a>file_write的工作流程</h3><p>(1)首先需要知道是些哪段字符？<br>file中一个读写指针，是开始地址（fseek就是修改它），再加正count</p>
<p><img src="https://i.loli.net/2019/03/04/5c7d359eedac2.jpg" alt></p>
<p><code>filp-&gt;f_pops</code>为读写位置,不断累加.追加指针放到文件末尾或者从中读取放到上一次读写的位置.</p>
<p>根据读写位置找到盘块号.读取到内存缓冲区,放到电梯队列上阻塞.读写完成后后pos增加,文件指针往后挪动</p>
<p>（2）找到要写的盘块号？<br>inode就是用来干这事的</p>
<p><img src="https://i.loli.net/2019/03/04/5c7d3967a4d57.jpg" alt></p>
<p>2^16*1024= 65536kb</p>
<p>一页索引1024,一个盘块号2个字节,只能表示512索引块.</p>
<p>根据读写的位置除以每一个读写的位置,字符流的位置除以表示每个块的大小,在哪个段上,再查证映射表对应的盘块号.再使用bread发出磁盘读写</p>
<p>添加new_block,需要先读入索引块确定正确位置</p>
<p>inode可以存放映射表,对于特殊文件可以存放设备号等信息</p>
<p>（3）用盘块号、buf等形<br>成request放入“电梯”</p>
<p><img src="https://i.loli.net/2019/03/04/5c7d3a8119558.jpg" alt></p>
<p>i_mode字符文件</p>
<p>i_zone是存放映射关系的,现在可以用来存放设备号</p>
<p>通过inode得到文件视图,如何打开文件</p>
<p>fd = open()<br>read(fd,…)</p>
<h4 id="打开文件"><a href="#打开文件" class="headerlink" title="打开文件"></a>打开文件</h4><p>从路径名/文件名找到inode,inode找到盘块号,盘块号放到电梯队列,根据盘块号算出chs,</p>
<p>根据out指令发出到磁盘控制器,驱动马达 电生磁 磁生电形成数据.</p>
<p><img src="https://i.loli.net/2019/03/05/5c7d5aba2d9a2.jpg" alt></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xwdidi.com/2019/02/19/2019-02-19-L29-从生磁盘到文件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xuwei98">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="偽のブログ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/19/2019-02-19-L29-从生磁盘到文件/" itemprop="url">设备驱动与文件系统    L29 从生磁盘到文件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-19T00:00:00+08:00">
                2019-02-19
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/19/2019-02-19-L29-从生磁盘到文件/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/19/2019-02-19-L29-从生磁盘到文件/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  466
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>如何从文件得到盘块号!</strong></p>
<p>###为什么引入文件</p>
<ul>
<li><p>引入第三层抽象.</p>
<p>让普通用户使用raw disk,操作信息更加简单.</p>
<p>用户眼中的文件是字符流的样子</p>
<p>而磁盘上的文件盘块接在一起.</p>
<ul>
<li>方法:建立字符流到盘块集合的映射关系<ul>
<li>映射的作用:字符流对应相应盘块号,处理相关字符就处理对应的盘块,与内存缓冲区进行交互.然后电梯队列进行写入,修改.</li>
</ul>
</li>
<li>操作系统封装了映射,对用户隐藏细节.</li>
</ul>
<h3 id="实现文件的数据结构"><a href="#实现文件的数据结构" class="headerlink" title="实现文件的数据结构"></a>实现文件的数据结构</h3><p>唯一的算出相应的盘块</p>
<ul>
<li><p>连续结构,</p>
<p>映射表中存放各个字符流的首地址和使用块数</p>
<p><img src="https://i.loli.net/2019/02/19/5c6b0ad3a8a7e.jpg" alt></p>
<p>局限性:文件需要整体拷贝,效率低下.直接存取很快,类似于数组,动态增长很吃力</p>
</li>
<li><p>链式结构实现文件(链表)</p>
<p>适合动态增长</p>
<p>局限性:存取慢</p>
</li>
<li><p>索引结构</p>
<p>有一个块专门做索引提供文件的对应盘块号</p>
<p><img src="https://i.loli.net/2019/02/19/5c6b10f402a56.jpg" alt></p>
</li>
</ul>
<ol>
<li>根据FCB先读入索引表</li>
<li>一旦开始读写200-212,就把索引块读出来,然后查找200-212,若对应1号盘块,则读写改变</li>
</ol>
<p>比链式结构块!,既适合读取也适合增长</p>
</li>
</ul>
<h3 id="实际系统使用的数据结构"><a href="#实际系统使用的数据结构" class="headerlink" title="实际系统使用的数据结构"></a>实际系统使用的数据结构</h3><p><strong>多级索引</strong></p>
<p><img src="https://i.loli.net/2019/02/19/5c6b127d99aba.jpg" alt></p>
<ul>
<li>小文件直接读写盘块</li>
<li>中型通过一阶间接索引读取</li>
<li>大型使用多级索引</li>
</ul>
<h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul>
<li><p>小文件高校访问</p>
</li>
<li><p>可以表示很大的文件</p>
</li>
<li><p>中等大小的文件访问也不慢</p>
</li>
</ul>
<p>实现了折中</p>
<p>通过维护文件中的inode信息,控制FCB信息,得到盘块号.磁盘中断时,从电梯队列中取出来,算出CHS,再通过out发到具体的磁盘马达驱动器上.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xwdidi.com/2019/02/16/2019-02-16-L28-生磁盘的使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xuwei98">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="偽のブログ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/16/2019-02-16-L28-生磁盘的使用/" itemprop="url">设备驱动与文件系统    L28 生磁盘的使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-16T00:00:00+08:00">
                2019-02-16
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/16/2019-02-16-L28-生磁盘的使用/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/16/2019-02-16-L28-生磁盘的使用/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.1k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  4
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="前文回顾"><a href="#前文回顾" class="headerlink" title="前文回顾"></a>前文回顾</h3><h3 id="本文重点"><a href="#本文重点" class="headerlink" title="本文重点"></a>本文重点</h3><p>让磁盘直接被使用起来,让磁盘工作起来.</p>
<p>​    发出一个读命令<br>​    将数据送往内存<br>​    读完后向CPU发出中断</p>
<ol>
<li><p>CPU向磁盘驱动器中的寄存器读写数据</p>
</li>
<li><p>磁盘控制器完成真正的工作,并向CPU发中断的信号</p>
</li>
</ol>
<h4 id="使用磁盘从认识磁盘开始"><a href="#使用磁盘从认识磁盘开始" class="headerlink" title="使用磁盘从认识磁盘开始"></a>使用磁盘从认识磁盘开始</h4><p><img src="https://i.loli.net/2019/02/15/5c65d554bb1f6.jpg" alt></p>
<h5 id="如何读-写一字节呢"><a href="#如何读-写一字节呢" class="headerlink" title="如何读/写一字节呢"></a>如何读/写一字节呢</h5><ol>
<li><p>移动到指定的磁道里</p>
<p>然后再一转,磁生电,将数据写到内存中</p>
</li>
<li><p>数据写入内存中</p>
<p>移动到指定的磁道里</p>
<p>转动,电生磁,将数据刻入到磁盘扇区里</p>
</li>
</ol>
<p>   移动磁头,旋转磁盘,和内存缓冲进行读写**</p>
<h4 id="直接使用磁盘"><a href="#直接使用磁盘" class="headerlink" title="直接使用磁盘"></a>直接使用磁盘</h4><p>程序告诉磁盘控制器’柱面’,’磁头’,’扇区’,’缓存位置’这几个参数</p>
<p><img src="https://img-blog.csdn.net/20140223134118796?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveGlhb21pbnRoZXJl/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt></p>
<p>柱面(C):硬盘中，不同盘片相同半径的磁道所组成的圆柱称为柱面</p>
<p>磁头(head):根据磁头读相应盘面</p>
<p>扇区:磁道按相应规则划分具有一定弧度的磁道部分</p>
<p>不同半径的同心圆称为磁道</p>
<p>缓冲位置</p>
<p>根据上速条件,可以利用DMA将磁盘与内存的数据进行交互</p>
<p><img src="https://i.loli.net/2019/02/15/5c65e378e8694.jpg" alt></p>
<p>通过out指令将各个参数信息通过移位得到磁盘控制器能识别的数据放到对应的端口上,</p>
<p>这个办法太过于直接,过于复杂.</p>
<h3 id="第一层抽象"><a href="#第一层抽象" class="headerlink" title="第一层抽象"></a>第一层抽象</h3><p>通过盘块号读写磁盘</p>
<ul>
<li><p>磁盘驱动负责从block计算出cyl，head，sec（CHS）</p>
<p>隐藏细节,减少用户负担.</p>
</li>
<li><p>如何编址呢?为什么这样做呢?</p>
<p>访问相邻的盘块可以快速读出.</p>
</li>
</ul>
<p>  磁盘访问时间=写入控制器时间+寻道时间(12ms to 8ms)+旋转时间(7200转,4ms半周)+传输时间(50m/s, 0.3s).</p>
<p>  寻道时间占主要时间,那么就尽量少寻道,所以相邻盘块号应该放在相邻或同一磁道上.</p>
<h4 id="从CHS到扇区号，从扇区到盘块"><a href="#从CHS到扇区号，从扇区到盘块" class="headerlink" title="从CHS到扇区号，从扇区到盘块"></a>从CHS到扇区号，从扇区到盘块</h4><p>通过C H S计算出block号,CxHxS+HxS+S</p>
<p><img src="https://i.loli.net/2019/02/16/5c67291c09111.jpg" alt></p>
<p>寻道时间+旋转时间仍占主要因素.用空间利用率的下降换取效率.的提升.一个盘块就是连续的几个扇区</p>
<p>根据盘块号访问多个扇区,提升读写速度</p>
<h4 id="接着使用磁盘-输出block"><a href="#接着使用磁盘-输出block" class="headerlink" title="接着使用磁盘 输出block"></a>接着使用磁盘 输出block</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">make_request</span><span class="params">()</span></span>&#123; <span class="comment">//处理磁盘请求</span></span><br><span class="line">    </span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">request</span> *<span class="title">req</span>;</span></span><br><span class="line">	req = requrest+NR_REQUEST;</span><br><span class="line">	req-&gt;sector = bh-&gt;b_blocknr&lt;&lt;<span class="number">1</span>;	<span class="comment">//根据block号算出扇区号,linux0.11的盘块是两个扇区</span></span><br><span class="line">    </span><br><span class="line">	add_request(major+blk_dev,req);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2019/02/16/5c674d1f598a9.jpg" alt></p>
<p>再使用得到的扇区数通过<code>divl</code>指令和<code>block = Cx(SxH)+HxS+S</code>公式得到相应的C H S,柱面磁头扇区</p>
<p><code>nsect</code>:每个盘块所拥有的扇区数量</p>
<h3 id="第二层抽象"><a href="#第二层抽象" class="headerlink" title="第二层抽象"></a>第二层抽象</h3><h4 id="多个进程通过队列使用磁盘"><a href="#多个进程通过队列使用磁盘" class="headerlink" title="多个进程通过队列使用磁盘"></a>多个进程通过队列使用磁盘</h4><p><img src="https://i.loli.net/2019/02/16/5c6750ba29511.jpg" alt></p>
<p>在磁盘驱动时,从请求队列取出.在磁盘中断时,从队列中取出</p>
<p>第二层抽象的核心在于请求队列中的调度问题,这时候我们来讨论讨论调度算法.(目标是平均访问延迟小,寻道时间是主要矛盾)</p>
<ol>
<li>FCFS</li>
</ol>
<p>磁盘作旋转运动,磁头在长途奔波.过于追求目的磁道,为何不顺路把路过的磁道也处理了呢?</p>
<ol start="2">
<li><p>SSTF磁盘调度 短寻道优先</p>
<p>磁头总是在中间柱面晃荡,会造成饥饿</p>
</li>
<li><p>最终 : scan 扫描调度(电机算法)</p>
<p>SSTF+中途不回折:每个请求都有处理的机会</p>
</li>
<li><p>c-scan (电梯算法)</p>
<p>scan+直接移到另一端:两端都能很快的处理</p>
</li>
</ol>
<p><img src="https://i.loli.net/2019/02/16/5c675a3430b8e.jpg" alt></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//终止条件</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>((IN_ORDER(tmp,req)||!IN_ORDER(tmp,tmp_&gt;next))&amp;&amp;IN_ORDER(req,tmp-&gt;next))</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OM_ORDER(s1,s20) \</span></span><br><span class="line">	(s1)-&gt;dev&lt;(s2)-&gt;dev||(s1)-&gt;dev ==(s2)-&gt;dev\</span><br><span class="line">	&amp;&amp; (s1)-&gt;sector&lt;(s2)_&gt;sector))</span><br><span class="line"><span class="comment">//IN_ORDER满足s1&lt;s2,就是c1&lt;c2根据柱面号排队列</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> tmp&lt;req&lt;next</span><br><span class="line"><span class="number">2.</span> tmp&gt;next req&lt;next -&gt;tmp&gt;next&gt;req</span><br></pre></td></tr></table></figure>
<h4 id="生磁盘使用整理"><a href="#生磁盘使用整理" class="headerlink" title="生磁盘使用整理"></a>生磁盘使用整理</h4><ol>
<li><p>进程得到盘块号,算出扇区号(sector)</p>
</li>
<li><p>用扇区号make req(做出磁盘请求,涉及内存缓冲申请和管理),用电梯算法add_request</p>
</li>
<li><p>进程sleep_on()(进程间同步)</p>
</li>
<li><p>进行中断处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">read_intr</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">	end_request(<span class="number">1</span>);<span class="comment">//唤醒进程</span></span><br><span class="line">	</span><br><span class="line">    do_hd_request(),</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>do_hd_request算出cyl,head,sector</p>
</li>
<li><p>hd_out调用outp(…)完成端口写</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xwdidi.com/2018/12/30/2018-12-30-L27-键盘/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xuwei98">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="偽のブログ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/30/2018-12-30-L27-键盘/" itemprop="url">设备驱动与文件系统    L27 键盘</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-30T00:00:00+08:00">
                2018-12-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/12/30/2018-12-30-L27-键盘/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/12/30/2018-12-30-L27-键盘/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  505
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前提提要"><a href="#前提提要" class="headerlink" title="前提提要"></a>前提提要</h2><p>设备的驱动,举了例子是显示器.</p>
<p>显示器是输出,键盘做基础的输入.</p>
<p>显示器和键盘合在一起是中断设备.</p>
<h2 id="本章重点"><a href="#本章重点" class="headerlink" title="本章重点"></a>本章重点</h2><h3 id="操作系统是怎么使用键盘的"><a href="#操作系统是怎么使用键盘的" class="headerlink" title="操作系统是怎么使用键盘的."></a>操作系统是怎么使用键盘的.</h3><p><img src="https://i.loli.net/2018/12/29/5c27785716fdb.jpg" alt></p>
<ol>
<li>out指令向外设发出命令</li>
<li>通过文件形成统一的文件视图</li>
<li>进行中断处理</li>
</ol>
<p>本章着重讲<strong>中断处理</strong></p>
<h3 id="如何使用键盘"><a href="#如何使用键盘" class="headerlink" title="如何使用键盘"></a>如何使用键盘</h3><ol>
<li><p>对于使用者: 敲键盘,看结果</p>
</li>
<li><p>对于OS,”等着”你敲键盘,敲了就中断</p>
</li>
<li><p>从键盘中断开始,也就是中断初始化开始.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">con_init</span><span class="params">(<span class="keyword">void</span>)</span>	<span class="comment">//应为键盘也是console的一部分</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    set_trap_gate(<span class="number">0x21</span>, &amp;ketborad_interrupt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在kerne1/chr drv/keyboard.s中</span></span><br><span class="line">   </span><br><span class="line">.glob1_keyboard_interrupt_keyboard_interrupt:</span><br><span class="line">inb $<span class="number">0x60</span>, %a1	<span class="comment">//从端口0x60读扫描吗,从控制器中的缓冲中读出来(ASCII码)</span></span><br><span class="line">   </span><br><span class="line"><span class="function">cal1 <span class="title">key_table</span><span class="params">(,%eax，<span class="number">4</span>)</span><span class="comment">//调用key_table+eax*4根据扫面码决定调用的函数.</span></span></span><br><span class="line"><span class="function">   </span></span><br><span class="line">… push $0 call_do_tty_interrupt</span><br></pre></td></tr></table></figure>
<p>解析key_table,是函数数组</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在kernel/chr_drv/keyborad.s中</span></span><br><span class="line"></span><br><span class="line">key_table:</span><br><span class="line">	.<span class="keyword">long</span> none,do_self,do_self,do_self	<span class="comment">//扫描码00-03,显示字符通常使用此函数进行处理</span></span><br><span class="line">        </span><br><span class="line">	.<span class="keyword">long</span> do_self, ... ,func,scroll,cursor 等等	<span class="comment">//func是反应f功能键的函数</span></span><br></pre></td></tr></table></figure>
<p>扫描码02对应对应按键1;01对应esc;12对应E等等</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mode:.byte 0</span><br><span class="line">do_self:</span><br><span class="line">lea alt_map,%ebx 	//找到映射表，如a的key_map映射为a，而shift_map映射为A</span><br><span class="line"></span><br><span class="line">testb $0x20,mode	//alt键是否同时按下 </span><br><span class="line"></span><br><span class="line">jne 1f lea_shift_map,%ebx </span><br><span class="line">testb $0x03,mode </span><br><span class="line">jne 1f lea_key_map,%ebx</span><br><span class="line">1：</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="https://i.loli.net/2018/12/31/5c29eafe4d44b.jpg" alt></p>
<p>​    通过ebx获得的起始地址和扫描码得到的偏移可写字符的ascii码,并且赋值给al.在放入到缓冲队列中.等进程执行获取队列中的数据. </p>
<p><img src="![1546251599844](C:\Users\ZJL\AppData\Roaming\Typora\typora-user-images\1546251599844.png" alt></p>
<p>tty_table[],终端设备使用的函数,</p>
<p>然后将al输入到队列的头部.</p>
<h4 id="现在没有回显功能"><a href="#现在没有回显功能" class="headerlink" title="现在没有回显功能."></a>现在没有回显功能.</h4><p><img src="https://i.loli.net/2018/12/31/5c29eefc71b52.jpg" alt></p>
<p>加工字符,将字符数据写入到显示队列中,然后显示字符.</p>
<h3 id="键盘的中断处理"><a href="#键盘的中断处理" class="headerlink" title="键盘的中断处理"></a>键盘的中断处理</h3><p><img src="https://i.loli.net/2018/12/31/5c29efd5b9981.jpg" alt></p>
<p>secondary中的数据才是scanf所需要的字符.</p>
<p>然后在write_q.显示</p>
<p><img src="https://i.loli.net/2018/12/31/5c29f091f070e.jpg" alt></p>
<ol>
<li>通过系统调用形成的统一的文件视图</li>
<li>最终落实到out/in指令</li>
<li>中断处理</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xwdidi.com/2018/12/29/2018-12-29-L26-IO与显示器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xuwei98">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="偽のブログ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/29/2018-12-29-L26-IO与显示器/" itemprop="url">设备驱动与文件系统  L26 I/O与显示器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-29T00:00:00+08:00">
                2018-12-29
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/12/29/2018-12-29-L26-IO与显示器/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/12/29/2018-12-29-L26-IO与显示器/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.7k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  7
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前文提要"><a href="#前文提要" class="headerlink" title="前文提要"></a>前文提要</h2><p>操作系统是管理硬件的软件.</p>
<p><img src="https://i.loli.net/2018/12/29/5c27785716fdb.jpg" alt>)学习得知<code>printf()</code>函数是如何将文字打印到显示屏上的</p>
<p>I\O设备:键盘和显示器,磁盘,文件系统(驱动磁盘设备)</p>
<p>##重点知识解析</p>
<h4 id="如何让外设工作"><a href="#如何让外设工作" class="headerlink" title="如何让外设工作"></a>如何让外设工作</h4><p>CPU发出指令,给显卡or键盘中的寄存器or磁盘控制的寄存器等等写入内容.也就是给相应的寄存器写入东西,通过本身的电路(芯片)进行操控设备.再通过这些设备操作外设.</p>
<ul>
<li>发出写命令</li>
<li>向CPU发出中断</li>
<li>读数据到内存</li>
</ul>
<p>发出核心指令类似这条<code>out xx,a</code>,这样就能让外设工作.外设完事之后,在进行中断的处理</p>
<ul>
<li>CPU向控制器中的寄存器读写数据</li>
<li>控制器完成真正的工作,并向CPU发出中断操作</li>
</ul>
<p>外设驱动过程:</p>
<ol>
<li><p>out指令(<code>out</code>)</p>
</li>
<li><p>外设执行后,要中断处理</p>
</li>
<li><p>提供统一的文件视图(接口),不同设备的控制器不一样. (printf)这样方便</p>
</li>
</ol>
<h3 id="一段操纵外设的程序"><a href="#一段操纵外设的程序" class="headerlink" title="一段操纵外设的程序"></a>一段操纵外设的程序</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> fd = open(<span class="string">"/dev/xxx"</span>)</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">    write(fd,i,<span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">&#125;</span><br><span class="line">close(fd)</span><br></pre></td></tr></table></figure>
<ol>
<li>不论什么设备都是open，read，write，close操作系统为用户提供统一的接口!</li>
<li>不同的设备对应不同的设备文件（（/devlxxx）根据设备文件找到控制器的地址、内容格式等等！</li>
</ol>
<p><img src="https://i.loli.net/2018/12/29/5c27805da34f4.jpg" alt></p>
<p>进行相应处理,根据文件名进行解释,到达控制器作用于实际的外设上,在进行中断处理.</p>
<h3 id="从操作文件的接口开始-开始给显示器输出"><a href="#从操作文件的接口开始-开始给显示器输出" class="headerlink" title="从操作文件的接口开始,开始给显示器输出"></a>从操作文件的接口开始,开始给显示器输出</h3><ol>
<li><code>printf(&quot;Host Name: %s&quot;,name)</code></li>
</ol>
<ul>
<li>先创建缓存buf将格式化输出都写到那里，然后write(1，buf.…)[写入显示器]明白<code>write</code>是如何实现的.最终指向<code>out</code>指令.out不同的端口or接口. </li>
</ul>
<ol start="2">
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在linux/fs/read write.c中</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_write</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> fd, <span class="keyword">char</span>*buf, <span class="keyword">int</span> count)</span>	<span class="comment">//fd是file的索引</span></span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span>*<span class="title">file</span>;</span></span><br><span class="line">	file=current-&gt;filp[fd]; <span class="comment">//fd = 1,代表这1的地方是一个文件.current代表当前进程</span></span><br><span class="line">    </span><br><span class="line">	inode=file-&gt;f_inode;	<span class="comment">//取出文件信息(显示器的信息应该就在这里)</span></span><br></pre></td></tr></table></figure>
<p>1是如何使用的呢.1给fd赋值.</p>
</li>
<li><p>fd=1的filp从哪里来？</p>
<p>因为是被current指向,所以是fork中来</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">copy_process</span><span class="params">(...)</span></span>&#123;</span><br><span class="line">    *p = *current;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>;i&lt;NR_OPEN;i++)</span><br><span class="line">        <span class="keyword">if</span>((f=p-&gt;filp[i])) f-&gt;f_count++;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>这个指针是从父进程继承过来的.</p>
<p>shel进程启动了whoami命令,shell是其父进程.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="keyword">if</span>(!fork())</span><br><span class="line">	&#123;</span><br><span class="line">		init();&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    open(<span class="string">"dev/tty0"</span>,O_RDWR,<span class="number">0</span>);dup(<span class="number">0</span>);dup(<span class="number">0</span>);	<span class="comment">//dup(0)拷贝两份描述符分别对应1,2.tty0都是终端设备.</span></span><br><span class="line">    </span><br><span class="line">    execve(<span class="string">"/bin/sh"</span>,argv,envp)	<span class="comment">// 启动shell代替子进程中的tty0程序</span></span><br><span class="line">								  					  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>/dev/tty 代表控制终端</p>
<p><code>dup()</code>传给该函数一个既有的描述符，返回一个新的描述符，新的描述符是传给它的描述符的拷贝.</p>
<ol start="4">
<li>open系统调用完成了什么呢</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在linux/fs/open.c中,解析目录找到inode</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>*filename,<span class="keyword">int</span> flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	i=open_namei(filename,flag,&amp;inode);<span class="comment">//根据文件名字读入文件</span></span><br><span class="line">    </span><br><span class="line">	cuurent-&gt;filp[fd]=f;<span class="comment">//第一个空闲的fd </span></span><br><span class="line">    </span><br><span class="line">	f-&gt;f_mode=inode-&gt;i_mode;</span><br><span class="line">	f-&gt;f_inode=inode;	<span class="comment">//读入inode,有着具体信息.</span></span><br><span class="line">    </span><br><span class="line">	f-&gt;f_count=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">return</span> fd;&#125;</span><br></pre></td></tr></table></figure>
<p>核心就是形成这样的一个链</p>
<p><img src="https://i.loli.net/2018/12/29/5c2789228e507.jpg" alt></p>
<p>当前的PCB根据链找到dev/tty对应的inode.根据inode找到所指向的设备.</p>
<h4 id="小总结"><a href="#小总结" class="headerlink" title="小总结"></a>小总结</h4><p>filp中的1由<code>open(&quot;/dev/tty0&quot;)</code>产生.write操作相应的inode写入信息.</p>
<h4 id="向屏幕输出"><a href="#向屏幕输出" class="headerlink" title="向屏幕输出"></a>向屏幕输出</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在linux/fs/read write.c中</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_write</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> fd,<span class="keyword">char</span>*buf,<span class="keyword">int</span> cnt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	inode = file-&gt;f_node;</span><br><span class="line">	<span class="keyword">if</span>(S_ISCHR(inode-&gt;i_mode))	<span class="comment">//判断是否是char(字符)设备,</span></span><br><span class="line">        </span><br><span class="line">		<span class="keyword">return</span> rw_char(WRITE,inode-&gt;i_zone[<span class="number">0</span>],buf,cnt);<span class="comment">//通过inode判断是字符的第几个字符设备</span></span><br><span class="line">    </span><br><span class="line">    	...</span><br></pre></td></tr></table></figure>
<p>转入<code>rw_char</code></p>
<p>在<code>/dev</code>中输入<code>ls -l</code>,能查主设备号和副设备号</p>
<p>假设主设备号是4.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在linux/fs/char dev.c中</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rw_char</span><span class="params">(<span class="keyword">int</span> rw,<span class="keyword">int</span> dev,<span class="keyword">char</span>*buf,<span class="keyword">int</span> cnt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	crw_ptr call_addr=crw_table[MAJOR(dev)];	<span class="comment">//通过主设备号查表,获得对应的处理函数地址,赋值给函数指针</span></span><br><span class="line">	call_addr(rw,dev,buf,cnt);...&#125;</span><br></pre></td></tr></table></figure>
<h4 id="看看crw-table"><a href="#看看crw-table" class="headerlink" title="看看crw_table"></a>看看<code>crw_table</code></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> crw_ptr crw_table[]=&#123;…, rw_ttyx,&#125;;<span class="comment">//第四个是rw_ttyx, crw_table函数指针数组</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> (*crw_ptr)(<span class="keyword">int</span> rw, <span class="keyword">unsigned</span> minor, <span class="keyword">char</span>* buf, <span class="keyword">int</span> count)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rw_ttyx</span><span class="params">(<span class="keyword">int</span> rw, <span class="keyword">unsigned</span> minor, <span class="keyword">char</span>* buf, <span class="keyword">int</span> count)</span><span class="comment">//此时rw==WRITE</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">	<span class="keyword">return</span>((rw==READ) ? tty_read(minor, buf):tty_write(minor, buf));<span class="comment">//写入缓冲</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分析tty_write//实现输出的核心</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在1inux/kernel/tty_io.c中</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tty_write</span><span class="params">(<span class="keyword">unsigned</span> channel,<span class="keyword">char</span>*buf,<span class="keyword">int</span> nr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span>*<span class="title">tty</span>;</span></span><br><span class="line">    tty=channel+tty_table;</span><br><span class="line">    sleep_if_full(&amp;tty-&gt;write_q); <span class="comment">//可以猜测:输出就是放入队列,满了的话就sleep</span></span><br><span class="line">    </span><br><span class="line">...</span><br><span class="line">	<span class="keyword">char</span> c,*b=buf;	<span class="comment">//buf在用户态内存,</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(nr&gt;<span class="number">0</span>&amp;&amp;!FULL(tty-&gt;write_q))&#123;</span><br><span class="line">        c = get_fs_byte(b);	<span class="comment">//fs从缓冲区读取</span></span><br><span class="line">        <span class="keyword">if</span>(c==<span class="string">'\r'</span>)&#123;</span><br><span class="line">            PUTCH(<span class="number">13</span>,tty-&gt;write_q);	<span class="comment">//放入队列中输出</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(O_LCUC(tty))</span><br><span class="line">            c = <span class="built_in">toupper</span>(c);</span><br><span class="line">        b++;</span><br><span class="line">        nr--;</span><br><span class="line">        PUTCH(c,tty-&gt;tty_write_q);</span><br><span class="line">    &#125;<span class="comment">//输出完事或写队列满</span></span><br><span class="line">    </span><br><span class="line">    tty-&gt;write(tty);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="tty-gt-write-tty-真的开始输出屏幕了"><a href="#tty-gt-write-tty-真的开始输出屏幕了" class="headerlink" title="tty-&gt;write(tty)真的开始输出屏幕了."></a><code>tty-&gt;write(tty)</code>真的开始输出屏幕了.</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在include/linux/tty.h中</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span>&#123;</span></span><br><span class="line">    <span class="keyword">void</span>(*write)(struct tty struct*tty);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty</span> _<span class="title">queue</span> <span class="title">read_q</span>,<span class="title">write_g</span>;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>tty中的write函数,再看看tty_struct的初始化</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> <span class="title">tty_table</span>[] = &#123;</span></span><br><span class="line">   &#123;con_write,&#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="string">""</span>&#125;,&#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="string">""</span>&#125;&#125;,&#123;&#125;,...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在看(consle)con_write实施细节</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在1inux/kerne1/chr drv/console.c中</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">con_write</span><span class="params">(struct tty_struct*tty)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GETCH(tty-&gt;write_q,c);</span><br><span class="line">	<span class="keyword">if</span>(c&gt;<span class="number">31</span>&amp;&amp;c&lt;<span class="number">127</span>)&#123;</span><br><span class="line">	__asm__(<span class="string">"movb _attr,%%ah\n\t"</span>  <span class="comment">//_attr是属性赋值给ah</span></span><br><span class="line">           </span><br><span class="line">	<span class="string">"movw %%ax,%1\n\t"</span>::<span class="string">"a"</span>(c),		<span class="comment">//字符c赋值给ax的al.ax赋值给%1(pos)\</span></span><br><span class="line">            </span><br><span class="line">	<span class="string">"m"</span>(*(<span class="keyword">short</span>*)pos):<span class="string">"ax"</span>);	<span class="comment">//pos就是显卡的控制器,ax字符放到显存上. </span></span><br><span class="line">        </span><br><span class="line">     pos+=<span class="number">2</span>;	<span class="comment">//写完显存后移,一个字符大小有16位(字符+字符属性).</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从write队列中获取数据,然后使用汇编代码.</p>
<p><strong>组原中讲过,如果是独立编制的控制器使用<code>out</code>指令,而控制器与内存统一编制时使用<code>mov</code>指令.</strong></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>从wirte开始,用到open获取到设备file,再根据file中的inode通过函数表获取到所需要的注册函数,再out出去.</p>
<p>这就是设备驱动.(</p>
<p>写设备驱动</p>
<ol>
<li>写入核心out指令</li>
<li>相应的函数注册到表中</li>
<li>再创建个dev下的文件,与表中函数对应</li>
</ol>
<h3 id="mov-pos解析"><a href="#mov-pos解析" class="headerlink" title="mov pos解析"></a><code>mov pos</code>解析</h3><p><img src="https://i.loli.net/2018/12/30/5c28ba6af1b36.jpg" alt></p>
<p>gotoxy()根据x,y的值和宏定义得到pos的值</p>
<p><code>0x90000</code>系统启动时,在setup时取出硬件的参数,将光标的位置(显存的位置)放到该地址处.改地址就是pos位置</p>
<p><img src="https://i.loli.net/2018/12/30/5c28bca8e245e.jpg" alt></p>
<p><code>mov pos,c</code></p>
<p><code>out pos,c</code></p>
<p>再包装成函数,文件</p>
<ul>
<li>用到了缓冲技术</li>
<li>同步机制</li>
</ul>
<p>核心就是cpu向控制器发出指令</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xwdidi.com/2018/12/18/2018-12-18-日语十一课ー誘い/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xuwei98">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="偽のブログ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/18/2018-12-18-日语十一课ー誘い/" itemprop="url">誘い   第十一课</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-18T00:00:00+08:00">
                2018-12-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/日语/" itemprop="url" rel="index">
                    <span itemprop="name">日语</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/12/18/2018-12-18-日语十一课ー誘い/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/12/18/2018-12-18-日语十一课ー誘い/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  293
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>実は<br>では　失礼します<br>ちょっと    表示省略</p>
<p>いいですか　か 疑问　<br>いいですよ    　よ 引起注意<br>ううですれ    　れ 表示确定<br>いいです<br><img src="https:\/\/i.loli.net\/2018\/12\/10\/5c0e77c7e6fd2.png" alt></p>
<p>みせます<br>あらいます<br>教えます　おしえます<br>またれ～</p>
<p>表达语句:</p>
<p>道を教えます</p>
<h3 id="て形"><a href="#て形" class="headerlink" title="て形"></a>て形</h3><p>一类动词:</p>
<p>話します　はなして</p>
<p>探します　さがして</p>
<p>だします　だして</p>
<p>します　－＞　して</p>
<p>書きます　かいて</p>
<p>聞きます　きいて</p>
<p>あるきます　歩いて</p>
<p>開きます　開いて</p>
<p>泳ぎます　泳いて</p>
<p>ます　－＞いて</p>
<p>ぎますー＞いで</p>
<p>買います　買って</p>
<p>まちます　まって　</p>
<p>かえります　帰って</p>
<p>あります　あって</p>
<p>います　ちます　ります　ー＞　って</p>
<p>死にます　しんで</p>
<p>読みます　よんで</p>
<p>呼びます　読んで</p>
<p>にます　みます　びます　－＞って</p>
<p>二类动词：</p>
<p>起（o ki）きます　起きて</p>
<p>寝(n e )ます　寝て</p>
<p>見(m i)ます　みて</p>
<p>食べ(ta be)ます　食べて</p>
<p>i ます</p>
<p>e ます</p>
<p>三类动词:</p>
<p>します　して</p>
<p>来ます　きて</p>
<p>アルバイトします　アルバイトして</p>
<p>勉強します　勉強して</p>
<p>-ますー＞　て</p>
<p><img src="https:\/\/i.loli.net\/2018\/12\/16\/5c165e3a107e1.jpg" alt></p>
<p>用语:</p>
<p>見てください</p>
<p>聞いてください</p>
<p>書いてください</p>
<p>読んでください</p>
<p>言ってください</p>
<p>練習をしてください</p>
<p>形容词修饰动词表示动作的状态</p>
<p>早く行きます</p>
<p>安く売ります</p>
<p>早くれます</p>
<p>邀请</p>
<p>Vませんか｜　Vましょう</p>
<p>コーヒーを飲みませんか</p>
<p>映画をみませんか</p>
<p>音楽を聞きませんか　</p>
<p>観光名所　</p>
<p>紅葉（もみじ)をみました</p>
<p>「まず外（そと）で体（からだ）を洗（あら）って、それからお湯の中に入り（はいり）ます」</p>
<p>常用表达:</p>
<ul>
<li><p>A:こーひでも（助词,语气委婉）飲みに行きませんか</p>
<p>B：いいですね</p>
<p>本でも読みましょう</p>
</li>
<li><p>A:お茶でもにもに行きませんか</p>
<p>B：いいですね</p>
</li>
<li><p>ドライブはご一緒にどうですか</p>
</li>
</ul>
<p>　　食事はご一緒にどうですか</p>
<p>都合　情况</p>
<p>温泉　おんせん</p>
<p>かんこう　観光</p>
<p>電話　でんわ</p>
<p>病気　びょうき</p>
<p>大丈夫　だいじょうぶ</p>
<p>もみじ　紅葉</p>
<p>名所　めいしょ</p>
<p>何時　なんじ</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xwdidi.com/2018/12/04/2018-12-04-L25内存换出/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xuwei98">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="偽のブログ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/04/2018-12-04-L25内存换出/" itemprop="url">内存管理    L25 内存换出 Swapout</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-04T00:00:00+08:00">
                2018-12-04
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/12/04/2018-12-04-L25内存换出/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/12/04/2018-12-04-L25内存换出/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.2k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  4
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>换入换出是合在一起进行的.</p>
<p>换入的目的,实现虚拟内存. 有换入就必须有换出,只有换出空出的新的空闲区域,才能放入新的数据.</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>主要讲算法.</p>
<blockquote>
<p>有换入就应该有换出</p>
</blockquote>
<p><code>page = get_free_page();</code></p>
<p><code>bread_page(page,current-&gt;excutable-&gt;i_dev,nr)</code></p>
<p>并不能粽是获得新的页,内存也是有限的</p>
<ul>
<li><h3 id="需要选择一页淘汰-换出到磁盘-选择哪一页-尝试"><a href="#需要选择一页淘汰-换出到磁盘-选择哪一页-尝试" class="headerlink" title="需要选择一页淘汰,换出到磁盘,选择哪一页?尝试"></a>需要选择一页淘汰,换出到磁盘,选择哪一页?尝试</h3></li>
</ul>
<h3 id="尝试"><a href="#尝试" class="headerlink" title="尝试"></a>尝试</h3><h4 id="1-FIFO"><a href="#1-FIFO" class="headerlink" title="1. FIFO"></a>1. FIFO</h4><p>FIFO(先入先出)页面置换.</p>
<p>实例介绍:分配了3个页框</p>
<p>每个页换入换出都不合时宜,太过于机械,大多数时间都浪费在I/O中.</p>
<p>缺页次数应该少.判断使用次数,最少的换出去.</p>
<p><img src="https://i.loli.net/2018/12/04/5c0688cbad61e.jpg" alt></p>
<p>产生七次缺页</p>
<h4 id="2-MIN算法："><a href="#2-MIN算法：" class="headerlink" title="2. MIN算法："></a>2. MIN算法：</h4><p>选最远将使用的页淘汰，是最优方案</p>
<p><img src="https://i.loli.net/2018/12/04/5c06867d65d76.jpg" alt></p>
<p>五次换页,</p>
<p>MIN需要知道将来发生的事…怎么办.</p>
<h3 id="3-LRU"><a href="#3-LRU" class="headerlink" title="3. LRU"></a>3. LRU</h3><p>least recent use 最近最少使用</p>
<p>用过去的历史预测将来/</p>
<p>选取最近最长一段时间没有使用的页淘汰(最近最少使用的页)</p>
<p>程序具有局部性的特点,这样算法会有较大的适应性</p>
<p> <img src="https://i.loli.net/2018/12/05/5c0795020db27.png" alt="1544000727828"></p>
<p>### </p>
<h3 id="1-LRU的准确实现-使用时间戳"><a href="#1-LRU的准确实现-使用时间戳" class="headerlink" title="1. LRU的准确实现,使用时间戳"></a>1. LRU的准确实现,使用时间戳</h3><p>通过对使用的页,每次使用时,增加时间戳.时间戳上显示使用该页的最后时间 .</p>
<p>若要进行换页选择时间戳最小的页换出.</p>
<p>根据查出来的逻辑页,需要去维护时间戳.每执行一条指令(取址执行),修改每个页的时间戳.同时要处理.时间戳存在溢出的危险,</p>
<p><img src="https://i.loli.net/2018/12/05/5c079b48f15a3.jpg" alt></p>
<blockquote>
<p>每次地址访问都需要修改时间戳，需维护一个全局时钟，需找到最小值..实现代价较大</p>
</blockquote>
<h3 id="2-若采用页码查找"><a href="#2-若采用页码查找" class="headerlink" title="2. 若采用页码查找"></a>2. 若采用页码查找</h3><p>在栈的顶部总是保留最近使用的页.</p>
<p>换页时,选择栈底页淘汰. </p>
<p><img src="https://i.loli.net/2018/12/05/5c079d2a0d887.jpg" alt></p>
<h3 id="3-LRU近似实现-将时间计数变为是和否"><a href="#3-LRU近似实现-将时间计数变为是和否" class="headerlink" title="3. LRU近似实现-将时间计数变为是和否"></a>3. LRU近似实现-将时间计数变为是和否</h3><p>不做时间戳,进计数,</p>
<ul>
<li><p>在每个页加一个引用位,访问过这一页这个数置为1</p>
</li>
<li><p>二次机会算法.Clock Algorithm</p>
<p><img src="https://i.loli.net/2018/12/05/5c07a570759d5.jpg" alt></p>
<p>进行扫描,访问过的位的数若为1,则置为0,不淘汰.</p>
<p>如果遇到0时,则被淘汰.  </p>
<p>1代表最近访问过, 而如果之前再次扫描到被置为0的那个页,则代表了在扫描的时间内没有被访问,则被替换出去.</p>
<p>为什么说是近似实现呢,最近没有使用是最近最少使用的近似.</p>
<p>只需要修改一个数,能减少操作数.因为要查页表,MMU直接自动的把R置成1，R可以直接放到页表项中，MMU自动做，不用去维护复杂的数据结构。</p>
</li>
</ul>
<h4 id="Clock算法的分析与改造"><a href="#Clock算法的分析与改造" class="headerlink" title="Clock算法的分析与改造"></a>Clock算法的分析与改造</h4><p>效率高，代价小。</p>
<p>然而: 如果缺页很少，会</p>
<p>导致很少从1置为0,会被一直访问,R全为1.如果全为1,扫描后全变为0,一圈后则会将初始的那页换出去,指针指向下一个.下一个与前面的过程相同,然后被换出.算法就变为了按顺序换出,不就是FIFO吗?</p>
<p>R记录了太长的历史信息,退化为FIFO.所以我们定时清除R位.再来个扫描指针</p>
<p><img src="https://i.loli.net/2018/12/05/5c07ac294d762.jpg" alt></p>
<p>缺页导致指针转的太慢,用扫描指针清零.被清零后又没被使用,仍然为0,则他会被调出.</p>
<h4 id="那么该给进程分配多少页框呢-物理内存"><a href="#那么该给进程分配多少页框呢-物理内存" class="headerlink" title="那么该给进程分配多少页框呢(物理内存)"></a>那么该给进程分配多少页框呢(物理内存)</h4><ul>
<li><p>分配过多,请求调页导致的内存高效就没了.</p>
</li>
<li><p>分配太少呢?<img src="https://i.loli.net/2018/12/05/5c07ad64b5d0f.jpg" alt></p>
<p>这一现象被称为颠簸.</p>
<p>原因解释：</p>
<p><strong>系统内进程增多&gt;每个进程的缺页率增大&gt;缺页率增大到一定程度，进程总等待调页完成&gt;</strong><br><strong>CPU利用率降低&gt;进程进一步增多，缺页率更大…</strong></p>
</li>
</ul>
<p>所以分配的局部,需要覆盖一个局部(通过某种算法求得的”工作集”),也可以通过动态调整页框数量,减少颠簸.</p>
<p>如果进程太多,无法囊括全部.需要限制进程数量,涉及CPU管理,进程管理.</p>
<p>clock环形数组+clock算法.</p>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>换入缺页,从磁盘读入一个页,可能没有足够的页大小,则使用clock算法换出一个页,再将页换入.这就是swap分区管理.</p>
<p>内存,时钟中断,磁盘管理,磁盘驱动.实现了换入换出的模型.又是为了实现虚拟内存,又是为了实现段页管理,又实现操作系统内存管理,又是为了实现程序的正常加载,又实现了进程.</p>
<p>形成了以进程带动的多进程推进,内存有效管理的图.初始化,系统接口,设备驱动,文件系统实现了基本简单完整的操作系统.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xwdidi.com/2018/12/03/2018-12-03-日语第十课/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xuwei98">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="偽のブログ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/03/2018-12-03-日语第十课/" itemprop="url">季節と天気   第十课</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-03T00:00:00+08:00">
                2018-12-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/日语/" itemprop="url" rel="index">
                    <span itemprop="name">日语</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/12/03/2018-12-03-日语第十课/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/12/03/2018-12-03-日语第十课/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  351
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>きせつ　季節</p>
<p>しき    四季</p>
<p>春　はる　　</p>
<p>夏    なつ</p>
<p>秋    あき</p>
<p>冬    ふゆ</p>
<p>天気　てんき</p>
<p>あたたかい　暖かい</p>
<p>あつい　あつい</p>
<p>闷热     蒸し暑い　むしあつい</p>
<p>涼しい　すずしい</p>
<p>さむい　寒い</p>
<p>あめ　雨</p>
<p>雨が降ります</p>
<p>ゆき</p>
<p>雪が降ります</p>
<p>風</p>
<p>風が吹きます</p>
<p>さくらが咲きます</p>
<p>花見をします　赏花</p>
<p>海　うみ</p>
<p>すいえい　水泳</p>
<p>私は海が好きです</p>
<p>花火　はなび</p>
<p>紅葉をみます</p>
<p>スキー　滑雪</p>
<p>スキー場　すきーじょう</p>
<p>四季がはっきりあります　　</p>
<p>はっきり　 清楚</p>
<p>梅雨　つゆ</p>
<p>台風　たいふう</p>
<p>洪水　こうずい</p>
<p>地震　じしん</p>
<p>津波　つなみ　海啸</p>
<p>私は日本</p>
<p>羨ましなあ</p>
<p>いや　</p>
<p>梅雨は嫌です</p>
<p>楽しい　たのしい</p>
<p>じゅう　</p>
<p>一年中　いちねんじゅう</p>
<p>日本中　にほんじゅう</p>
<p>今日中　きょじゅう</p>
<p>島国　しまぐに</p>
<p>北海道　ほっかいどう</p>
<p>札幌　さっぽろ</p>
<p>仙台　せんだい</p>
<p>東京　とうきょう</p>
<p>名古屋　なごや</p>
<p>京都　きょうと</p>
<p>おおさか　大阪</p>
<p>神戸　こうべ</p>
<p>広島　ひろしま</p>
<p>四国　しこく</p>
<p>きゅうしゅう　九州</p>
<p>福岡　ふくおか</p>
<p>沖縄　おきなわ</p>
<p>Aかったです　い变为かった</p>
<p>寒い　寒かった　寒かったです</p>
<p>可愛い　可愛かった　可愛かったです</p>
<p>いい    よかった</p>
<p>昨日は暖かったです　　　　　<br>昨日は暑かったです。　　<br>昨日はさむかったです、きょうはさむくないです</p>
<p>Aくなかったです　否定</p>
<p>寒くないです</p>
<p>寒くなかったです　过去否定</p>
<p>寒くありません</p>
<p>寒くありませんでした</p>
<p>昔　以前</p>
<p>昨日は寒かったです、今日も寒いです。</p>
<p>二类形容词</p>
<p>ANでした/ANではありませんでした</p>
<p>李さんはコーヒーがきらいでした</p>
<p>静か　ふべん　きれい</p>
<p>前のアパートは静かでした。ふべんでした。きれいではありませんでした</p>
<p>形容词表示变化</p>
<p>Aく／ANに　＋　なります</p>
<p>１．　～くなります    寒くなります    今日は暖かくなりました。</p>
<p>２．　けれいになりました</p>
<p>形容词并列</p>
<p>Aくて／ANで</p>
<p>～～Aくて</p>
<p>１．</p>
<p>安くて美味しいです</p>
<p>ひるは暑くて、よるは寒いです</p>
<p>２．</p>
<p>このアパートは静かで便利です</p>
<p>図書館はしずかで、公園はにぎやかです</p>
<p>修饰名词</p>
<p>AいN／ANなN</p>
<p>広い部屋</p>
<p>面白い映画を見ました</p>
<p>美味しい日本料理をたべました。</p>
<p>静かな町</p>
<p>有名な大学</p>
<p>綺麗な桜をみました</p>
<p><img src="https://i.loli.net/2018/12/03/5c052db339238.png" alt></p>
<p>今度　こんど</p>
<p>うらやましいなあ</p>
<p>裏日本</p>
<p>表日本</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Xuwei98">
            
              <p class="site-author-name" itemprop="name">Xuwei98</p>
              <p class="site-description motion-element" itemprop="description">圈地自萌,自娱自乐</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">51</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Xuwei98" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:z1002280879@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
<br>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=1350129459&auto=1&height=66"></iframe>

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xuwei98</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">47.7k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://xuwei98.disqus.com/count.js" async></script>
    

    

  




	





  














  





  

  

  

  
  

  

  

  

</body>
</html>
